<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Solid Studio Pro</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SolidStudio">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @font-face { font-family: 'Circular'; src: url('fonts/Circular/Circular-Black.ttf') format('truetype'); font-weight: 900; }
        @font-face { font-family: 'Circular'; src: url('fonts/Circular/Circular-Bold.ttf') format('truetype'); font-weight: 700; }
        @font-face { font-family: 'Circular'; src: url('fonts/Circular/Circular-Medium.ttf') format('truetype'); font-weight: 500; }
        @font-face { font-family: 'Circular'; src: url('fonts/Circular/Circular-Book.ttf') format('truetype'); font-weight: 400; }
        
        body {
            font-family: 'Circular', -apple-system, sans-serif;
            background-color: #09090b;
            color: white;
            margin: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        textarea, input { font-size: 16px !important; user-select: text; }

        .canvas-container {
            transition: transform 0.2s ease-out;
            transform-origin: center;
            will-change: transform;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        .color-dot-active {
            outline: 2px solid #3b82f6;
            outline-offset: 3px;
            transform: scale(0.9);
        }

        .gradient-selector-active {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
            z-index: 10;
        }

        .weight-btn-active {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }

        html { overscroll-behavior-y: none; }

        #exportModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            padding: 2rem;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .tab-active {
            background: #27272a;
            color: white;
        }

        /* Gradient Palette Styles */
        .color-palette-popover {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1c1c21;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 12px;
            width: 200px;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            margin-bottom: 12px;
            z-index: 50;
        }
        
        .color-palette-popover.visible {
            display: grid;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen w-screen overflow-hidden">

    <!-- Export Modal (Mobile & Fallback) -->
    <div id="exportModal" class="flex">
        <div class="max-w-md w-full flex flex-col items-center gap-6">
            <p class="text-center font-bold text-lg">Right-click or Long-press to save image</p>
            <img id="exportPreview" class="w-full h-auto rounded-xl shadow-2xl border border-white/10" alt="Export Preview">
            <button id="closeExport" class="bg-white/10 px-8 py-3 rounded-full font-bold hover:bg-white/20 transition-all">Close</button>
        </div>
    </div>

    <!-- Viewport Area -->
    <main id="viewport" class="flex-grow bg-[#050507] flex items-center justify-center relative overflow-hidden h-[45vh] md:h-full p-4 md:p-8 touch-none">
        <div id="container" class="canvas-container relative bg-black shadow-2xl flex-shrink-0" style="width: 1000px; height: 1000px;">
            <canvas id="mainCanvas" width="1000" height="1000" class="w-full h-full block"></canvas>
        </div>
    </main>

    <!-- Sidebar Panel -->
    <aside class="w-full md:w-[400px] bg-[#121217] border-t md:border-t-0 md:border-l border-white/5 p-6 md:p-8 flex flex-col gap-6 md:gap-8 overflow-y-auto shadow-2xl z-10 md:h-full h-[55vh] pb-safe">
        
        <section class="space-y-3">
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                <i data-lucide="type" class="w-3.5 h-3.5"></i> Text
            </div>
            <textarea id="textInput" class="w-full bg-[#1c1c21] border border-white/5 rounded-xl p-4 text-base focus:border-blue-500 outline-none transition-all resize-none text-white font-inherit" rows="2">My Playlist Title</textarea>
        </section>

        <section class="space-y-3">
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                <i data-lucide="bold" class="w-3.5 h-3.5"></i> Weight
            </div>
            <div class="grid grid-cols-4 gap-2 bg-[#1c1c21] p-2 rounded-xl border border-white/5">
                <button data-weight="400" class="weight-btn py-3 rounded-lg text-lg font-[400] hover:bg-white/5 bg-transparent transition-all">B</button>
                <button data-weight="500" class="weight-btn py-3 rounded-lg text-lg font-[500] hover:bg-white/5 bg-transparent transition-all">B</button>
                <button data-weight="700" class="weight-btn py-3 rounded-lg text-lg font-[700] hover:bg-white/5 bg-transparent transition-all weight-btn-active">B</button>
                <button data-weight="900" class="weight-btn py-3 rounded-lg text-lg font-[900] hover:bg-white/5 bg-transparent transition-all">B</button>
            </div>
        </section>

        <section class="space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                    <i data-lucide="palette" class="w-3.5 h-3.5"></i> Appearance
                </div>
                <div class="flex bg-[#1c1c21] p-1 rounded-lg border border-white/5">
                    <button id="tabSolid" class="text-[10px] px-3 py-1 rounded-md font-bold uppercase transition-all tab-active">Solid</button>
                    <button id="tabGradient" class="text-[10px] px-3 py-1 rounded-md font-bold uppercase transition-all text-zinc-500">Gradient</button>
                </div>
            </div>

            <!-- Solid Picker -->
            <div id="solidControls" class="bg-[#1c1c21] rounded-xl p-4 border border-white/5 grid grid-cols-6 gap-3"></div>

            <!-- Gradient Picker -->
            <div id="gradientControls" class="hidden bg-[#1c1c21] rounded-xl p-5 border border-white/5 space-y-4">
                <div class="space-y-4">
                    <div class="flex items-center justify-between text-[10px] font-bold uppercase text-zinc-500">
                        <span>Varying Layers</span>
                        <button id="shuffleGradientColors" class="hover:text-white transition-colors"><i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i></button>
                    </div>
                    <div class="flex justify-between items-center px-2 relative">
                        <!-- Gradient Slot 1 -->
                        <div class="relative group">
                            <button id="slot0" class="grad-slot w-10 h-10 rounded-full border-2 border-white/10 bg-[#272a48]"></button>
                            <span class="text-[8px] text-center block mt-1 text-zinc-500 font-bold uppercase">Base</span>
                        </div>
                        <!-- Gradient Slot 2 -->
                        <div class="relative group">
                            <button id="slot1" class="grad-slot w-10 h-10 rounded-full border-2 border-white/10 bg-[#4490ef]"></button>
                            <span class="text-[8px] text-center block mt-1 text-zinc-500 font-bold uppercase">Layer 1</span>
                        </div>
                        <!-- Gradient Slot 3 -->
                        <div class="relative group">
                            <button id="slot2" class="grad-slot w-10 h-10 rounded-full border-2 border-white/10 bg-[#272a48]"></button>
                            <span class="text-[8px] text-center block mt-1 text-zinc-500 font-bold uppercase">Layer 2</span>
                        </div>
                        <!-- Gradient Slot 4 -->
                        <div class="relative group">
                            <button id="slot3" class="grad-slot w-10 h-10 rounded-full border-2 border-white/10 bg-[#d8305f]"></button>
                            <span class="text-[8px] text-center block mt-1 text-zinc-500 font-bold uppercase">Layer 3</span>
                        </div>
                        
                        <!-- Shared Color Picker Popover -->
                        <div id="colorPopover" class="color-palette-popover"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="space-y-3">
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                <i data-lucide="image" class="w-3.5 h-3.5"></i> Background Image
            </div>
            <div class="flex gap-2">
                <label class="flex-grow bg-[#1c1c21] border border-dashed border-white/10 rounded-xl p-3 flex items-center justify-center gap-2 cursor-pointer hover:border-blue-500/50 transition-all">
                    <input type="file" id="imageUpload" class="hidden" accept="image/*">
                    <i data-lucide="upload-cloud" class="w-4 h-4 text-zinc-400"></i>
                    <span class="text-xs font-medium text-zinc-400" id="uploadLabel">Upload JPG/PNG</span>
                </label>
                <button id="clearImage" class="hidden w-12 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-xl items-center justify-center transition-all">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </section>

        <section class="space-y-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                    <i data-lucide="layers" class="w-3.5 h-3.5"></i> Overlays
                </div>
                <button id="blendModeToggle" class="text-[10px] font-bold bg-white/5 px-3 py-1 rounded-full hover:bg-white/10 transition-colors uppercase tracking-wider text-zinc-400 hover:text-white">Blend Mode: Blend</button>
            </div>
            <div class="flex flex-col gap-3">
                <div class="bg-[#1c1c21] p-3 rounded-xl border border-white/5 space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium">Shape Overlay</span>
                            <span id="shapeLabel" class="text-[10px] text-zinc-500 uppercase font-bold mt-0.5">Variant 01</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="shuffleShapeBtn" class="p-2 hover:bg-white/5 rounded-lg transition-colors text-zinc-400 hover:text-white"><i data-lucide="shuffle" class="w-4 h-4"></i></button>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="shapeToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-[#1c1c21] p-3 rounded-xl border border-white/5">
                    <span class="text-sm font-medium">Frame Overlay</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="frameToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
        </section>

        <div class="flex gap-3 mt-auto pt-6 pb-24">
            <button id="exportBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 active:scale-95 transition-all rounded-xl p-4 font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20">
                <i data-lucide="download" class="w-4 h-4"></i> 
                <span>Save Image</span>
            </button>
            <button id="randomBtn" class="w-14 h-14 bg-white/5 hover:bg-white/10 active:scale-90 border border-white/5 transition-all rounded-xl flex items-center justify-center">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            </button>
        </div>
    </aside>

    <script>
        const CANVAS_SIZE = 1000;
        const BASE_PALETTE = [[100, 116, 139], [239, 68, 68], [249, 115, 22], [245, 158, 11], [234, 179, 8], [34, 197, 94], [16, 185, 129], [20, 184, 166], [6, 182, 212], [14, 165, 233], [59, 130, 246], [99, 102, 241]];
        const NEW_HEX_COLORS = ["#355B58", "#524A41", "#535647", "#5E3D5E", "#50525A", "#6A5645", "#6A6248", "#4B5D45", "#365567", "#53e14c", "#FA4E63", "#17A8FF", "#F5C81E", "#C24C2D", "#3B356A", "#6C2D55", "#9B4658", "#133F35"];

        let activeColor = [59, 130, 246];
        let gradColors = ["#272a48", "#4490ef", "#272a48", "#d8305f"];
        let activeShapeIndex = "01";
        let activeWeight = 700;
        let bgImage = null;
        let blendMode = 'overlay'; 
        let backgroundMode = 'solid';
        let currentSlotIndex = 0;
        const allColors = [];
        const images = {};

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('container');
        const viewport = document.getElementById('viewport');
        const textInput = document.getElementById('textInput');
        const solidControls = document.getElementById('solidControls');
        const gradientControls = document.getElementById('gradientControls');
        const tabSolid = document.getElementById('tabSolid');
        const tabGradient = document.getElementById('tabGradient');
        const exportBtn = document.getElementById('exportBtn');
        const randomBtn = document.getElementById('randomBtn');
        const shuffleShapeBtn = document.getElementById('shuffleShapeBtn');
        const shapeToggle = document.getElementById('shapeToggle');
        const frameToggle = document.getElementById('frameToggle');
        const blendModeToggle = document.getElementById('blendModeToggle');
        const colorPopover = document.getElementById('colorPopover');
        const exportModal = document.getElementById('exportModal');
        const exportPreview = document.getElementById('exportPreview');
        const closeExport = document.getElementById('closeExport');

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null;
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function initColors() {
            BASE_PALETTE.forEach(c => allColors.push(c));
            NEW_HEX_COLORS.forEach(h => { const rgb = hexToRgb(h); if (rgb) allColors.push(rgb); });
            
            // Build Solid Grid
            allColors.forEach(rgb => {
                const btn = document.createElement('button');
                btn.className = 'aspect-square rounded-full transition-all duration-200 hover:scale-110';
                btn.style.backgroundColor = `rgb(${rgb.join(',')})`;
                btn.onclick = () => { activeColor = rgb; updateActiveUI(); render(); };
                solidControls.appendChild(btn);
            });

            // Build Popover Grid
            allColors.forEach(rgb => {
                const hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
                const btn = document.createElement('button');
                btn.className = 'w-6 h-6 rounded-full border border-white/10 hover:scale-125 transition-transform';
                btn.style.backgroundColor = hex;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    gradColors[currentSlotIndex] = hex;
                    document.getElementById(`slot${currentSlotIndex}`).style.backgroundColor = hex;
                    colorPopover.classList.remove('visible');
                    render();
                };
                colorPopover.appendChild(btn);
            });

            updateActiveUI();
        }

        async function preloadImages() {
            const paths = {'shape_01': 'overlay/shape_01.png', 'shape_02': 'overlay/shape_02.png', 'shape_03': 'overlay/shape_03.png', 'frame': 'overlay/frame.png'};
            const load = (k, s) => new Promise(resolve => {
                const i = new Image();
                i.onload = () => { images[k] = i; resolve(); };
                i.onerror = () => resolve();
                i.src = s;
            });
            await Promise.all(Object.entries(paths).map(([k, v]) => load(k, v)));
        }

        function updateActiveUI() {
            solidControls.querySelectorAll('button').forEach((b, i) => {
                if (JSON.stringify(allColors[i]) === JSON.stringify(activeColor)) b.classList.add('color-dot-active');
                else b.classList.remove('color-dot-active');
            });
            
            gradColors.forEach((hex, i) => {
                document.getElementById(`slot${i}`).style.backgroundColor = hex;
            });
        }

        function render() {
            const text = textInput.value;
            ctx.globalCompositeOperation = 'source-over';
            
            if (backgroundMode === 'solid') {
                ctx.fillStyle = `rgb(${activeColor.join(',')})`;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            } else {
                ctx.fillStyle = gradColors[0];
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

                // Varied Layer 1: Bottom Right Focus
                let grad1 = ctx.createRadialGradient(CANVAS_SIZE * 0.9, CANVAS_SIZE * 0.9, 0, CANVAS_SIZE * 0.8, CANVAS_SIZE * 0.8, CANVAS_SIZE * 0.9);
                grad1.addColorStop(0, gradColors[1]);
                grad1.addColorStop(1, 'transparent');
                ctx.fillStyle = grad1;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

                // Varied Layer 2: Top Center Focus
                let grad2 = ctx.createRadialGradient(CANVAS_SIZE * 0.45, CANVAS_SIZE * 0.05, 0, CANVAS_SIZE * 0.5, CANVAS_SIZE * 0.1, CANVAS_SIZE * 0.7);
                grad2.addColorStop(0, gradColors[2]);
                grad2.addColorStop(1, 'transparent');
                ctx.fillStyle = grad2;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

                // Varied Layer 3: Left Side Edge
                let grad3 = ctx.createRadialGradient(CANVAS_SIZE * 0.05, CANVAS_SIZE * 0.5, 0, CANVAS_SIZE * 0.1, CANVAS_SIZE * 0.5, CANVAS_SIZE * 0.8);
                grad3.addColorStop(0, gradColors[3]);
                grad3.addColorStop(1, 'transparent');
                ctx.fillStyle = grad3;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            }

            if (bgImage) {
                const scale = Math.max(CANVAS_SIZE / bgImage.width, CANVAS_SIZE / bgImage.height);
                const x = (CANVAS_SIZE / 2) - (bgImage.width / 2) * scale;
                const y = (CANVAS_SIZE / 2) - (bgImage.height / 2) * scale;
                ctx.drawImage(bgImage, x, y, bgImage.width * scale, bgImage.height * scale);
            }

            const currentBlendMode = blendMode === 'overlay' ? 'overlay' : 'source-over';
            
            if (shapeToggle.checked && images[`shape_${activeShapeIndex}`]) {
                ctx.globalCompositeOperation = currentBlendMode; 
                ctx.drawImage(images[`shape_${activeShapeIndex}`], 0, 0, CANVAS_SIZE, CANVAS_SIZE);
            }

            if (frameToggle.checked && images['frame']) {
                ctx.globalCompositeOperation = currentBlendMode;
                ctx.drawImage(images['frame'], 0, 0, CANVAS_SIZE, CANVAS_SIZE);
            }

            ctx.globalCompositeOperation = 'source-over';
            let brightness;
            if (backgroundMode === 'solid') {
                brightness = (activeColor[0] * 299 + activeColor[1] * 587 + activeColor[2] * 114) / 1000;
            } else {
                const rgbBase = hexToRgb(gradColors[0]);
                brightness = (rgbBase[0] * 299 + rgbBase[1] * 587 + rgbBase[2] * 114) / 1000;
            }
            
            ctx.fillStyle = (bgImage || brightness < 160) ? '#ffffff' : '#000000';
            ctx.font = `${activeWeight} 90px "Circular", -apple-system, sans-serif`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'alphabetic';

            const maxWidth = 760;
            const x = 116; 
            const bottomAnchor = 889; 
            const lineHeight = 89;

            const words = text.split(' ');
            let line = '';
            const lines = [];

            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                    lines.push(line.trim());
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line.trim());

            for (let i = 0; i < lines.length; i++) {
                const yPos = bottomAnchor - (i * lineHeight);
                ctx.fillText(lines[lines.length - 1 - i], x, yPos);
            }
            
            document.getElementById('shapeLabel').textContent = `Variant ${activeShapeIndex}`;
            blendModeToggle.textContent = `Blend Mode: ${blendMode === 'overlay' ? 'Blend' : 'Normal'}`;
        }

        // Popover Control
        document.querySelectorAll('.grad-slot').forEach((btn, idx) => {
            btn.onclick = (e) => {
                e.stopPropagation();
                currentSlotIndex = idx;
                colorPopover.classList.add('visible');
            };
        });

        document.addEventListener('click', () => {
            colorPopover.classList.remove('visible');
        });

        tabSolid.onclick = () => {
            backgroundMode = 'solid';
            tabSolid.classList.add('tab-active'); tabSolid.classList.remove('text-zinc-500');
            tabGradient.classList.remove('tab-active'); tabGradient.classList.add('text-zinc-500');
            solidControls.classList.remove('hidden'); gradientControls.classList.add('hidden');
            render();
        };

        tabGradient.onclick = () => {
            backgroundMode = 'gradient';
            tabGradient.classList.add('tab-active'); tabGradient.classList.remove('text-zinc-500');
            tabSolid.classList.remove('tab-active'); tabSolid.classList.add('text-zinc-500');
            gradientControls.classList.remove('hidden'); solidControls.classList.add('hidden');
            render();
        };

        document.getElementById('shuffleGradientColors').onclick = () => {
            const pick = () => {
                const rgb = allColors[Math.floor(Math.random() * allColors.length)];
                return rgbToHex(rgb[0], rgb[1], rgb[2]);
            };
            gradColors = gradColors.map(() => pick());
            updateActiveUI();
            render();
        };

        imageUpload.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (f) => {
                const img = new Image();
                img.onload = () => {
                    bgImage = img;
                    document.getElementById('uploadLabel').textContent = file.name;
                    document.getElementById('clearImage').style.display = 'flex';
                    render();
                };
                img.src = f.target.result;
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('clearImage').onclick = () => {
            bgImage = null;
            imageUpload.value = '';
            document.getElementById('uploadLabel').textContent = 'Upload JPG/PNG';
            document.getElementById('clearImage').style.display = 'none';
            render();
        };

        document.querySelectorAll('.weight-btn').forEach(btn => {
            btn.onclick = () => {
                activeWeight = parseInt(btn.dataset.weight);
                document.querySelectorAll('.weight-btn').forEach(b => b.classList.remove('weight-btn-active'));
                btn.classList.add('weight-btn-active');
                render();
            };
        });

        blendModeToggle.onclick = () => {
            blendMode = blendMode === 'overlay' ? 'source-over' : 'overlay';
            render();
        };

        // Improved Export for Desktop
        exportBtn.onclick = () => {
            const dataUrl = canvas.toDataURL('image/png', 1.0);
            
            // Create a temporary link and trigger it
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `solid-studio-${Date.now()}.png`;
            
            // Append to body to ensure it works in all environments
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Also show preview modal as feedback/alternative
            exportPreview.src = dataUrl;
            exportModal.style.display = 'flex';
        };

        closeExport.onclick = () => { exportModal.style.display = 'none'; };

        function updateScale() {
            const padding = window.innerWidth < 768 ? 40 : 80;
            const scale = Math.min((viewport.clientWidth - padding) / CANVAS_SIZE, (viewport.clientHeight - padding) / CANVAS_SIZE);
            container.style.transform = `scale(${scale})`;
        }

        window.onresize = updateScale;
        textInput.oninput = render;
        shapeToggle.onchange = render;
        frameToggle.onchange = render;
        
        shuffleShapeBtn.onclick = () => {
            activeShapeIndex = ["01", "02", "03"][(["01", "02", "03"].indexOf(activeShapeIndex) + 1) % 3];
            shapeToggle.checked = true;
            render();
        };

        randomBtn.onclick = () => {
            if (backgroundMode === 'solid') {
                activeColor = allColors[Math.floor(Math.random() * allColors.length)];
                updateActiveUI();
            } else {
                document.getElementById('shuffleGradientColors').click();
            }
            render();
        };

        window.onload = async () => {
            lucide.createIcons();
            initColors();
            await preloadImages();
            if (document.fonts) await document.fonts.ready;
            updateScale();
            render();
        };
    </script>
</body>
</html>