<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Solid Studio Pro</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SolidStudio">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @font-face { font-family: 'Circular'; src: url('fonts/Circular/Circular-Black.ttf') format('truetype'); font-weight: 900; }
        @font-face { font-family: 'Circular'; src: url('fonts/Circular/Circular-Bold.ttf') format('truetype'); font-weight: 700; }
        @font-face { font-family: 'Circular'; src: url('fonts/Circular/Circular-Medium.ttf') format('truetype'); font-weight: 500; }
        @font-face { font-family: 'Circular'; src: url('fonts/Circular/Circular-Book.ttf') format('truetype'); font-weight: 400; }
        
        body {
            font-family: 'Circular', -apple-system, sans-serif;
            background-color: #09090b;
            color: white;
            margin: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        textarea, input { font-size: 16px !important; user-select: text; }

        .canvas-container {
            transition: transform 0.2s ease-out;
            transform-origin: center;
            will-change: transform;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        .color-dot-active {
            outline: 2px solid #3b82f6;
            outline-offset: 3px;
            transform: scale(0.9);
        }

        .weight-btn-active, .size-btn-active, .snap-btn-active {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }

        html { overscroll-behavior-y: none; }

        #exportModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            padding: 2rem;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .tab-active {
            background: #27272a;
            color: white;
        }

        .color-palette-popover {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1c1c21;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 12px;
            width: 200px;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            margin-bottom: 12px;
            z-index: 50;
        }
        
        .color-palette-popover.visible {
            display: grid;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .icon-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1c1c21;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .icon-item:hover {
            background: #27272a;
            border-color: rgba(255,255,255,0.1);
        }

        .icon-item.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen w-screen overflow-hidden">

    <!-- Export Modal -->
    <div id="exportModal">
        <div class="max-w-md w-full flex flex-col items-center gap-6">
            <p class="text-center font-bold text-lg">Right-click or Long-press to save image</p>
            <img id="exportPreview" class="w-full h-auto rounded-xl shadow-2xl border border-white/10" alt="Export Preview">
            <button id="closeExport" class="bg-white/10 px-8 py-3 rounded-full font-bold hover:bg-white/20 transition-all">Close</button>
        </div>
    </div>

    <!-- Viewport Area -->
    <main id="viewport" class="flex-grow bg-[#050507] flex items-center justify-center relative overflow-hidden h-[45vh] md:h-full p-4 md:p-8 touch-none">
        <div id="container" class="canvas-container relative bg-black shadow-2xl flex-shrink-0" style="width: 1000px; height: 1000px;">
            <canvas id="mainCanvas" width="1000" height="1000" class="w-full h-full block cursor-crosshair"></canvas>
        </div>
    </main>

    <!-- Sidebar Panel -->
    <aside class="w-full md:w-[400px] bg-[#121217] border-t md:border-t-0 md:border-l border-white/5 p-6 md:p-8 flex flex-col gap-6 md:gap-8 overflow-y-auto shadow-2xl z-10 md:h-full h-[55vh] pb-safe">
        
        <section class="space-y-3">
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                <i data-lucide="type" class="w-3.5 h-3.5"></i> Text
            </div>
            <textarea id="textInput" class="w-full bg-[#1c1c21] border border-white/5 rounded-xl p-4 text-base focus:border-blue-500 outline-none transition-all resize-none text-white font-inherit" rows="2">My Playlist Title</textarea>
        </section>

        <!-- Icon Picker Section -->
        <section class="space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                    <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> Icon Overlay
                </div>
                <button id="clearIcon" class="text-[10px] text-red-400 font-bold uppercase hover:opacity-80 hidden">Clear</button>
            </div>
            <div class="space-y-2">
                <input type="text" id="iconSearch" placeholder="Search icons (music, heart, fire...)" class="w-full bg-[#1c1c21] border border-white/5 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none">
                <div id="iconGrid" class="icon-grid p-2 bg-[#09090b] rounded-xl border border-white/5">
                    <!-- Icons injected here -->
                </div>
            </div>
            <div class="grid grid-cols-3 gap-1 bg-[#1c1c21] p-1 rounded-xl border border-white/5 mt-2">
                <button data-snap="0" class="snap-btn p-2 rounded-lg hover:bg-white/5 text-[10px] font-bold">TOP-L</button>
                <button data-snap="1" class="snap-btn p-2 rounded-lg hover:bg-white/5 text-[10px] font-bold">TOP-C</button>
                <button data-snap="2" class="snap-btn p-2 rounded-lg hover:bg-white/5 text-[10px] font-bold">TOP-R</button>
                <button data-snap="3" class="snap-btn p-2 rounded-lg hover:bg-white/5 text-[10px] font-bold">MID-L</button>
                <button data-snap="4" class="snap-btn p-2 rounded-lg hover:bg-white/5 text-[10px] font-bold">CENTER</button>
                <button data-snap="5" class="snap-btn p-2 rounded-lg hover:bg-white/5 text-[10px] font-bold">MID-R</button>
                <button data-snap="6" class="snap-btn p-2 rounded-lg hover:bg-white/5 text-[10px] font-bold">BOT-L</button>
                <button data-snap="7" class="snap-btn p-2 rounded-lg hover:bg-white/5 text-[10px] font-bold">BOT-C</button>
                <button data-snap="8" class="snap-btn p-2 rounded-lg hover:bg-white/5 text-[10px] font-bold">BOT-R</button>
            </div>
        </section>

        <section class="space-y-3">
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                <i data-lucide="maximize" class="w-3.5 h-3.5"></i> Size
            </div>
            <div class="grid grid-cols-2 gap-2 bg-[#1c1c21] p-2 rounded-xl border border-white/5">
                <button data-size="90" class="size-btn py-2.5 rounded-lg text-xs font-bold uppercase hover:bg-white/5 bg-transparent transition-all size-btn-active">Standard</button>
                <button data-size="120" class="size-btn py-2.5 rounded-lg text-xs font-bold uppercase hover:bg-white/5 bg-transparent transition-all">Large</button>
            </div>
        </section>

        <section class="space-y-3">
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                <i data-lucide="bold" class="w-3.5 h-3.5"></i> Weight
            </div>
            <div class="grid grid-cols-4 gap-2 bg-[#1c1c21] p-2 rounded-xl border border-white/5">
                <button data-weight="400" class="weight-btn py-3 rounded-lg text-lg font-[400] hover:bg-white/5 bg-transparent transition-all">B</button>
                <button data-weight="500" class="weight-btn py-3 rounded-lg text-lg font-[500] hover:bg-white/5 bg-transparent transition-all">B</button>
                <button data-weight="700" class="weight-btn py-3 rounded-lg text-lg font-[700] hover:bg-white/5 bg-transparent transition-all weight-btn-active">B</button>
                <button data-weight="900" class="weight-btn py-3 rounded-lg text-lg font-[900] hover:bg-white/5 bg-transparent transition-all">B</button>
            </div>
        </section>

        <section class="space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                    <i data-lucide="palette" class="w-3.5 h-3.5"></i> Appearance
                </div>
                <div class="flex bg-[#1c1c21] p-1 rounded-lg border border-white/5">
                    <button id="tabSolid" class="text-[10px] px-3 py-1 rounded-md font-bold uppercase transition-all tab-active">Solid</button>
                    <button id="tabGradient" class="text-[10px] px-3 py-1 rounded-md font-bold uppercase transition-all text-zinc-500">Gradient</button>
                </div>
            </div>
            <div id="solidControls" class="bg-[#1c1c21] rounded-xl p-4 border border-white/5 grid grid-cols-6 gap-3"></div>
            <div id="gradientControls" class="hidden bg-[#1c1c21] rounded-xl p-5 border border-white/5 space-y-4">
                <div class="space-y-4">
                    <div class="flex items-center justify-between text-[10px] font-bold uppercase text-zinc-500">
                        <span>Varying Layers</span>
                        <button id="shuffleGradientColors" class="hover:text-white transition-colors"><i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i></button>
                    </div>
                    <div class="flex justify-between items-center px-2 relative">
                        <button id="slot0" class="grad-slot w-10 h-10 rounded-full border-2 border-white/10"></button>
                        <button id="slot1" class="grad-slot w-10 h-10 rounded-full border-2 border-white/10"></button>
                        <button id="slot2" class="grad-slot w-10 h-10 rounded-full border-2 border-white/10"></button>
                        <button id="slot3" class="grad-slot w-10 h-10 rounded-full border-2 border-white/10"></button>
                        <div id="colorPopover" class="color-palette-popover"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="space-y-3">
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                <i data-lucide="image" class="w-3.5 h-3.5"></i> Background Image
            </div>
            <div class="flex gap-2">
                <label class="flex-grow bg-[#1c1c21] border border-dashed border-white/10 rounded-xl p-3 flex items-center justify-center gap-2 cursor-pointer hover:border-blue-500/50 transition-all">
                    <input type="file" id="imageUpload" class="hidden" accept="image/*">
                    <i data-lucide="upload-cloud" class="w-4 h-4 text-zinc-400"></i>
                    <span class="text-xs font-medium text-zinc-400" id="uploadLabel">Upload JPG/PNG</span>
                </label>
                <button id="clearImage" class="hidden w-12 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-xl items-center justify-center transition-all">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </section>

        <section class="space-y-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                    <i data-lucide="layers" class="w-3.5 h-3.5"></i> Overlays
                </div>
                <button id="blendModeToggle" class="text-[10px] font-bold bg-white/5 px-3 py-1 rounded-full hover:bg-white/10 transition-colors uppercase tracking-wider text-zinc-400 hover:text-white">Blend Mode: Blend</button>
            </div>
            <div class="flex flex-col gap-3">
                <div class="bg-[#1c1c21] p-3 rounded-xl border border-white/5 space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium">Shape Overlay</span>
                            <span id="shapeLabel" class="text-[10px] text-zinc-500 uppercase font-bold mt-0.5">Variant 01</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="shuffleShapeBtn" class="p-2 hover:bg-white/5 rounded-lg transition-colors text-zinc-400 hover:text-white"><i data-lucide="shuffle" class="w-4 h-4"></i></button>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="shapeToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-[#1c1c21] p-3 rounded-xl border border-white/5">
                    <span class="text-sm font-medium">Frame Overlay</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="frameToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
        </section>

        <div class="flex gap-3 mt-auto pt-6 pb-24">
            <button id="exportBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 active:scale-95 transition-all rounded-xl p-4 font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20">
                <i data-lucide="download" class="w-4 h-4"></i> 
                <span>Save Image</span>
            </button>
            <button id="randomBtn" class="w-14 h-14 bg-white/5 hover:bg-white/10 active:scale-90 border border-white/5 transition-all rounded-xl flex items-center justify-center">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            </button>
        </div>
    </aside>

    <script>
        const CANVAS_SIZE = 1000;
        const BASE_PALETTE = [[100, 116, 139], [239, 68, 68], [249, 115, 22], [245, 158, 11], [234, 179, 8], [34, 197, 94], [16, 185, 129], [20, 184, 166], [6, 182, 212], [14, 165, 233], [59, 130, 246], [99, 102, 241]];
        const NEW_HEX_COLORS = ["#355B58", "#524A41", "#535647", "#5E3D5E", "#50525A", "#6A5645", "#6A6248", "#4B5D45", "#365567", "#53e14c", "#FA4E63", "#17A8FF", "#F5C81E", "#C24C2D", "#3B356A", "#6C2D55", "#9B4658", "#133F35"];

        let activeColor = [59, 130, 246];
        let gradColors = ["#272a48", "#4490ef", "#272a48", "#d8305f"];
        let activeShapeIndex = "01";
        let activeWeight = 700;
        let activeFontSize = 90;
        let bgImage = null;
        let blendMode = 'overlay'; 
        let backgroundMode = 'solid';
        let currentSlotIndex = 0;
        const allColors = [];
        const images = {};

        // Icon State
        let selectedIconName = null;
        let iconImg = null;
        let iconPos = { x: 500, y: 300 }; // Default center-topish
        const ICON_SIZE = 120;
        let isDraggingIcon = false;
        const snapPoints = [
            {x: 150, y: 150}, {x: 500, y: 150}, {x: 850, y: 150},
            {x: 150, y: 500}, {x: 500, y: 500}, {x: 850, y: 500},
            {x: 150, y: 850}, {x: 500, y: 850}, {x: 850, y: 850}
        ];

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('container');
        const viewport = document.getElementById('viewport');
        const textInput = document.getElementById('textInput');
        const solidControls = document.getElementById('solidControls');
        const gradientControls = document.getElementById('gradientControls');
        const tabSolid = document.getElementById('tabSolid');
        const tabGradient = document.getElementById('tabGradient');
        const exportBtn = document.getElementById('exportBtn');
        const randomBtn = document.getElementById('randomBtn');
        const shuffleShapeBtn = document.getElementById('shuffleShapeBtn');
        const shapeToggle = document.getElementById('shapeToggle');
        const frameToggle = document.getElementById('frameToggle');
        const blendModeToggle = document.getElementById('blendModeToggle');
        const colorPopover = document.getElementById('colorPopover');
        const exportModal = document.getElementById('exportModal');
        const exportPreview = document.getElementById('exportPreview');
        const closeExport = document.getElementById('closeExport');
        const iconSearch = document.getElementById('iconSearch');
        const iconGrid = document.getElementById('iconGrid');
        const clearIconBtn = document.getElementById('clearIcon');

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null;
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function initColors() {
            BASE_PALETTE.forEach(c => allColors.push(c));
            NEW_HEX_COLORS.forEach(h => { const rgb = hexToRgb(h); if (rgb) allColors.push(rgb); });
            
            allColors.forEach(rgb => {
                const btn = document.createElement('button');
                btn.className = 'aspect-square rounded-full transition-all duration-200 hover:scale-110';
                btn.style.backgroundColor = `rgb(${rgb.join(',')})`;
                btn.onclick = () => { activeColor = rgb; updateActiveUI(); render(); };
                solidControls.appendChild(btn);
            });

            allColors.forEach(rgb => {
                const hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
                const btn = document.createElement('button');
                btn.className = 'w-6 h-6 rounded-full border border-white/10 hover:scale-125 transition-transform';
                btn.style.backgroundColor = hex;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    gradColors[currentSlotIndex] = hex;
                    document.getElementById(`slot${currentSlotIndex}`).style.backgroundColor = hex;
                    colorPopover.classList.remove('visible');
                    render();
                };
                colorPopover.appendChild(btn);
            });
            updateActiveUI();
        }

        async function preloadImages() {
            // Mocking overlay paths - in real world these need to exist
            const paths = {'shape_01': 'overlay/shape_01.png', 'shape_02': 'overlay/shape_02.png', 'shape_03': 'overlay/shape_03.png', 'frame': 'overlay/frame.png'};
            const load = (k, s) => new Promise(resolve => {
                const i = new Image();
                i.onload = () => { images[k] = i; resolve(); };
                i.onerror = () => resolve();
                i.src = s;
            });
            await Promise.all(Object.entries(paths).map(([k, v]) => load(k, v)));
        }

        function initIconPicker() {
            const commonIcons = ['music', 'heart', 'star', 'flame', 'zap', 'disc', 'radio', 'mic', 'headphones', 'volume-2', 'shuffle', 'repeat', 'play', 'pause', 'cloud', 'sun', 'moon', 'ghost', 'skull', 'crown', 'diamond', 'coffee', 'pizza', 'camera', 'map-pin', 'anchor', 'wind', 'droplets', 'leaf', 'tree-pine'];
            
            function renderGrid(filter = '') {
                iconGrid.innerHTML = '';
                const list = filter ? Object.keys(lucide.icons).filter(k => k.toLowerCase().includes(filter.toLowerCase())) : commonIcons;
                
                list.slice(0, 60).forEach(name => {
                    const div = document.createElement('div');
                    div.className = `icon-item ${selectedIconName === name ? 'active' : ''}`;
                    div.innerHTML = `<i data-lucide="${name}" class="w-5 h-5"></i>`;
                    div.onclick = () => selectIcon(name);
                    iconGrid.appendChild(div);
                });
                lucide.createIcons();
            }

            iconSearch.oninput = (e) => renderGrid(e.target.value);
            renderGrid();
        }

        async function selectIcon(name) {
            selectedIconName = name;
            clearIconBtn.classList.remove('hidden');
            document.querySelectorAll('.icon-item').forEach(el => el.classList.remove('active'));
            
            // Create SVG data URL
            const iconData = lucide.icons[name];
            if (!iconData) return;

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('stroke', 'currentColor');
            svg.setAttribute('stroke-width', '2');
            svg.setAttribute('stroke-linecap', 'round');
            svg.setAttribute('stroke-linejoin', 'round');
            
            // Reconstruct path elements from lucide data
            iconData[2].forEach(p => {
                const path = document.createElementNS('http://www.w3.org/2000/svg', p[0]);
                Object.entries(p[1]).forEach(([attr, val]) => path.setAttribute(attr, val));
                svg.appendChild(path);
            });

            const svgString = new XMLSerializer().serializeToString(svg);
            const encodedData = window.btoa(svgString);
            
            iconImg = new Image();
            iconImg.onload = render;
            iconImg.src = `data:image/svg+xml;base64,${encodedData}`;
            
            // Visual feedback on grid
            initIconPicker();
        }

        clearIconBtn.onclick = () => {
            selectedIconName = null;
            iconImg = null;
            clearIconBtn.classList.add('hidden');
            render();
        };

        // Interaction Logic
        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = CANVAS_SIZE / rect.width;
            const scaleY = CANVAS_SIZE / rect.height;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!iconImg) return;
            const coords = getCanvasCoords(e);
            const dist = Math.hypot(coords.x - iconPos.x, coords.y - iconPos.y);
            if (dist < ICON_SIZE / 1.5) {
                isDraggingIcon = true;
                container.style.transition = 'none'; // Disable scale animation while dragging
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDraggingIcon) return;
            const coords = getCanvasCoords(e);
            iconPos = coords;
            render();
        });

        window.addEventListener('mouseup', () => {
            isDraggingIcon = false;
            container.style.transition = '';
        });

        // Touch support
        canvas.addEventListener('touchstart', (e) => {
            if (!iconImg) return;
            const coords = getCanvasCoords(e);
            const dist = Math.hypot(coords.x - iconPos.x, coords.y - iconPos.y);
            if (dist < ICON_SIZE / 1.5) {
                isDraggingIcon = true;
                e.preventDefault();
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if (!isDraggingIcon) return;
            const coords = getCanvasCoords(e);
            iconPos = coords;
            render();
            e.preventDefault();
        }, { passive: false });

        canvas.addEventListener('touchend', () => isDraggingIcon = false);

        document.querySelectorAll('.snap-btn').forEach((btn, idx) => {
            btn.onclick = () => {
                iconPos = { ...snapPoints[idx] };
                document.querySelectorAll('.snap-btn').forEach(b => b.classList.remove('snap-btn-active'));
                btn.classList.add('snap-btn-active');
                render();
            };
        });

        function updateActiveUI() {
            solidControls.querySelectorAll('button').forEach((b, i) => {
                if (JSON.stringify(allColors[i]) === JSON.stringify(activeColor)) b.classList.add('color-dot-active');
                else b.classList.remove('color-dot-active');
            });
            
            gradColors.forEach((hex, i) => {
                const el = document.getElementById(`slot${i}`);
                if (el) el.style.backgroundColor = hex;
            });
        }

        function render() {
            const text = textInput.value;
            ctx.clearRect(0,0, CANVAS_SIZE, CANVAS_SIZE);
            ctx.globalCompositeOperation = 'source-over';
            
            // 1. Background
            if (backgroundMode === 'solid') {
                ctx.fillStyle = `rgb(${activeColor.join(',')})`;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            } else {
                ctx.fillStyle = gradColors[0];
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                let grad1 = ctx.createRadialGradient(CANVAS_SIZE * 0.9, CANVAS_SIZE * 0.9, 0, CANVAS_SIZE * 0.8, CANVAS_SIZE * 0.8, CANVAS_SIZE * 0.9);
                grad1.addColorStop(0, gradColors[1]);
                grad1.addColorStop(1, 'transparent');
                ctx.fillStyle = grad1;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                let grad2 = ctx.createRadialGradient(CANVAS_SIZE * 0.45, CANVAS_SIZE * 0.05, 0, CANVAS_SIZE * 0.5, CANVAS_SIZE * 0.1, CANVAS_SIZE * 0.7);
                grad2.addColorStop(0, gradColors[2]);
                grad2.addColorStop(1, 'transparent');
                ctx.fillStyle = grad2;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                let grad3 = ctx.createRadialGradient(CANVAS_SIZE * 0.05, CANVAS_SIZE * 0.5, 0, CANVAS_SIZE * 0.1, CANVAS_SIZE * 0.5, CANVAS_SIZE * 0.8);
                grad3.addColorStop(0, gradColors[3]);
                grad3.addColorStop(1, 'transparent');
                ctx.fillStyle = grad3;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            }

            if (bgImage) {
                const scale = Math.max(CANVAS_SIZE / bgImage.width, CANVAS_SIZE / bgImage.height);
                const x = (CANVAS_SIZE / 2) - (bgImage.width / 2) * scale;
                const y = (CANVAS_SIZE / 2) - (bgImage.height / 2) * scale;
                ctx.drawImage(bgImage, x, y, bgImage.width * scale, bgImage.height * scale);
            }

            // 2. Overlays
            const currentBlendMode = blendMode === 'overlay' ? 'overlay' : 'source-over';
            
            if (shapeToggle.checked && images[`shape_${activeShapeIndex}`]) {
                ctx.globalCompositeOperation = currentBlendMode; 
                ctx.drawImage(images[`shape_${activeShapeIndex}`], 0, 0, CANVAS_SIZE, CANVAS_SIZE);
            }

            if (frameToggle.checked && images['frame']) {
                ctx.globalCompositeOperation = currentBlendMode;
                ctx.drawImage(images['frame'], 0, 0, CANVAS_SIZE, CANVAS_SIZE);
            }

            ctx.globalCompositeOperation = 'source-over';
            
            // Determine Brightness for Contrast
            let brightness;
            if (backgroundMode === 'solid') {
                brightness = (activeColor[0] * 299 + activeColor[1] * 587 + activeColor[2] * 114) / 1000;
            } else {
                const rgbBase = hexToRgb(gradColors[0]);
                brightness = (rgbBase[0] * 299 + rgbBase[1] * 587 + rgbBase[2] * 114) / 1000;
            }
            const contrastColor = (bgImage || brightness < 140) ? '#ffffff' : '#000000';

            // 3. Icon Overlay
            if (iconImg) {
                ctx.save();
                ctx.translate(iconPos.x, iconPos.y);
                ctx.fillStyle = contrastColor;
                ctx.strokeStyle = contrastColor;
                // Draw icon with manual coloring using a temporary canvas if needed, 
                // but for SVG data urls color is set via string. Using globalComposite for tint:
                ctx.drawImage(iconImg, -ICON_SIZE/2, -ICON_SIZE/2, ICON_SIZE, ICON_SIZE);
                
                // If it's white/black and needs tinting to the contrast color:
                ctx.globalCompositeOperation = 'source-in';
                ctx.fillStyle = contrastColor;
                ctx.fillRect(-ICON_SIZE/2, -ICON_SIZE/2, ICON_SIZE, ICON_SIZE);
                ctx.restore();
            }

            // 4. Text Overlay
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = contrastColor;
            ctx.font = `${activeWeight} ${activeFontSize}px "Circular", -apple-system, sans-serif`;
            ctx.textAlign = 'left';

            const maxWidth = 760;
            const x = 116; 
            const bottomAnchor = 887; 
            const lineHeight = activeFontSize * 1.05;

            const words = text.split(' ');
            let line = '';
            const lines = [];

            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                    lines.push(line.trim());
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line.trim());

            for (let i = 0; i < lines.length; i++) {
                const yPos = bottomAnchor - (i * lineHeight);
                ctx.fillText(lines[lines.length - 1 - i], x, yPos);
            }
            
            document.getElementById('shapeLabel').textContent = `Variant ${activeShapeIndex}`;
            blendModeToggle.textContent = `Blend Mode: ${blendMode === 'overlay' ? 'Blend' : 'Normal'}`;
        }

        // Generic Event Handlers
        tabSolid.onclick = () => {
            backgroundMode = 'solid';
            tabSolid.classList.add('tab-active');
            tabGradient.classList.remove('tab-active');
            solidControls.classList.remove('hidden');
            gradientControls.classList.add('hidden');
            render();
        };

        tabGradient.onclick = () => {
            backgroundMode = 'gradient';
            tabGradient.classList.add('tab-active');
            tabSolid.classList.remove('tab-active');
            gradientControls.classList.remove('hidden');
            solidControls.classList.add('hidden');
            render();
        };

        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.onclick = () => {
                activeFontSize = parseInt(btn.dataset.size);
                document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('size-btn-active'));
                btn.classList.add('size-btn-active');
                render();
            };
        });

        document.getElementById('shuffleGradientColors').onclick = () => {
            const pick = () => {
                const rgb = allColors[Math.floor(Math.random() * allColors.length)];
                return rgbToHex(rgb[0], rgb[1], rgb[2]);
            };
            gradColors = gradColors.map(() => pick());
            updateActiveUI();
            render();
        };

        imageUpload.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (f) => {
                const img = new Image();
                img.onload = () => {
                    bgImage = img;
                    document.getElementById('uploadLabel').textContent = file.name;
                    document.getElementById('clearImage').style.display = 'flex';
                    render();
                };
                img.src = f.target.result;
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('clearImage').onclick = () => {
            bgImage = null;
            imageUpload.value = '';
            document.getElementById('uploadLabel').textContent = 'Upload JPG/PNG';
            document.getElementById('clearImage').style.display = 'none';
            render();
        };

        document.querySelectorAll('.weight-btn').forEach(btn => {
            btn.onclick = () => {
                activeWeight = parseInt(btn.dataset.weight);
                document.querySelectorAll('.weight-btn').forEach(b => b.classList.remove('weight-btn-active'));
                btn.classList.add('weight-btn-active');
                render();
            };
        });

        blendModeToggle.onclick = () => {
            blendMode = blendMode === 'overlay' ? 'source-over' : 'overlay';
            render();
        };

        exportBtn.onclick = () => {
            const dataUrl = canvas.toDataURL('image/png', 1.0);
            exportPreview.src = dataUrl;
            exportModal.style.display = 'flex';
        };

        closeExport.onclick = () => { exportModal.style.display = 'none'; };

        function updateScale() {
            const padding = window.innerWidth < 768 ? 20 : 80;
            const scale = Math.min((viewport.clientWidth - padding) / CANVAS_SIZE, (viewport.clientHeight - padding) / CANVAS_SIZE);
            container.style.transform = `scale(${scale})`;
        }

        window.onresize = updateScale;
        textInput.oninput = render;
        shapeToggle.onchange = render;
        frameToggle.onchange = render;
        
        shuffleShapeBtn.onclick = () => {
            activeShapeIndex = ["01", "02", "03"][(["01", "02", "03"].indexOf(activeShapeIndex) + 1) % 3];
            shapeToggle.checked = true;
            render();
        };

        randomBtn.onclick = () => {
            if (backgroundMode === 'solid') {
                activeColor = allColors[Math.floor(Math.random() * allColors.length)];
                updateActiveUI();
            } else {
                document.getElementById('shuffleGradientColors').click();
            }
            render();
        };

        window.onload = async () => {
            lucide.createIcons();
            initColors();
            initIconPicker();
            await preloadImages();
            if (document.fonts) await document.fonts.ready;
            updateScale();
            render();
        };
    </script>
</body>
</html>