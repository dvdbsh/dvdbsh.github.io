<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>London News</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <style>
    :root { --accent: #4f8299; --read: #2fb617; }
    * { box-sizing: border-box; }
    body {
      font-family: 'Nunito', sans-serif;
      background: #292a2d;
      margin: 0;
      padding: 0 1.5rem 60px;
    }
    header {
      background: var(--accent);
      padding: 1rem 1.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      margin: 0 -1.5rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 { font-size: 1.5rem; font-weight: 800; color: white; margin: 0; }
    .menu-btn {
      font-size: 1.75rem;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }
    .settings-panel {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: #fff;
      color: #000;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      display: none;
      z-index: 100;
      max-height: 80vh;
      overflow-y: auto;
    }
    .settings-panel.active { display: block; }
    .settings-panel label { display: block; margin: 0.5rem 0; font-size: 0.9rem; }
    .source-scroller-wrapper {
      overflow-x: auto;
      margin: 0 -1.5rem 1.5rem;
      padding: 0 1.5rem;
      scrollbar-width: none;
    }
    .source-scroller-wrapper::-webkit-scrollbar { display: none; }
    .source-scroller {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .source-scroller button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      background: white;
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .source-scroller button.active {
      box-shadow: inset 0 0 0 2px var(--accent);
    }
    .feed {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
    }
    .card {
      background: #1f1f1f;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      transition: all 0.4s ease;
      position: relative;
      max-height: 340px;
      cursor: pointer;
    }
    .card.expanded { max-height: none; }
    .read-icon {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      font-size: 1.75rem;
      color: var(--read);
      display: none;
    }
    .card.read .read-icon { display: block; }
    .card img {
      width: 100%;
      height: 210px;
      object-fit: cover;
    }
    .card-content { padding: 1rem; }
    .card-content h2 {
      margin: 0 0 0.5rem; font-weight: 700;
      color: #e8eeff; font-size: 1.2rem;
    }
    .card-content .meta {
      font-size: 0.75rem; color: #999; margin-bottom: 0.75rem;
    }
    .full-content {
      font-size: 1rem; line-height: 1.6; color: #aeafb1;
      opacity: 0; max-height: 0;
      overflow: hidden; transition: all 0.4s ease;
    }
    .card.expanded .full-content {
      opacity: 1; margin-top: 1rem; max-height: none;
    }
    .read-more {
      margin-top: 1rem;
      background: var(--accent);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
    }
    .related {
      margin-top: 1rem;
      border-top: 1px solid #ddd;
      padding-top: 1rem;
    }
    .related a {
      color: #ccc;
      text-decoration: underline;
      font-size: 0.9rem;
      display: block;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>

<header>
  <h1>London News</h1>
  <button class="menu-btn" onclick="settingsPanel.classList.toggle('active')">
    <i class='bx bx-menu'></i>
  </button>
</header>

<div id="settingsPanel" class="settings-panel">
  <strong>Optional CBC Feeds</strong>
  <label><input type="checkbox" value="https://rsshub.app/feed/http://feeds.cbc.ca/indepth"> Top Stories</label>
  <label><input type="checkbox" value="https://rsshub.app/feed/http://feeds.cbc.ca/cbc/world"> World News</label>
  <label><input type="checkbox" value="https://rsshub.app/feed/http://feeds.cbc.ca/cbc/canadanews"> Canada News</label>
  <label><input type="checkbox" value="https://rsshub.app/feed/http://feeds.cbc.ca/cbc/politics"> Politics News</label>
  <label><input type="checkbox" value="https://rsshub.app/feed/http://feeds.cbc.ca/cbc/business"> Business News</label>
  <label><input type="checkbox" value="https://rsshub.app/feed/http://feeds.cbc.ca/cbc/health"> Health News</label>
  <label><input type="checkbox" value="https://rsshub.app/feed/http://feeds.cbc.ca/itms-sports/cfl"> CFL News</label>
  <label><input type="checkbox" value="https://rsshub.app/feed/http://feeds.cbc.ca/itms-sports/golf"> Golf News</label>
</div>

<div class="source-scroller-wrapper">
  <div class="source-scroller" id="sourceScroller"></div>
</div>

<div class="feed" id="newsFeed"></div>

<script>
const defaultSources = [
  {name: 'Global News', url: 'https://rsshub.app/feed/https://globalnews.ca/london/feed'},
  {name: 'CTV News London', url: 'https://rsshub.app/feed/https://london.ctvnews.ca/rss/ctv-news-london-1.1073369'},
  {name: 'CBC News London', url: 'https://rsshub.app/feed/https://www.cbc.ca/cmlink/rss-canada-london'},
  {name: '106.9 The X', url: 'https://rsshub.app/feed/https://www.1069thex.com/category/news-home-page/feed/'},
  {name: 'The London Free Press', url: 'https://rsshub.app/feed/https://lfpress.com/feed'}
];

const settingsPanel = document.getElementById('settingsPanel');
const sourceScroller = document.getElementById('sourceScroller');
const newsFeed = document.getElementById('newsFeed');
const readSet = new Set(JSON.parse(localStorage.getItem('readArticles') || '[]'));
let filter = 'all';

function saveRead(id) {
  readSet.add(id);
  localStorage.setItem('readArticles', JSON.stringify([...readSet]));
}

function renderSources(sources) {
  sourceScroller.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.textContent = 'All';
  allBtn.classList.add('active');
  allBtn.onclick = () => { filter = 'all'; switchActive(allBtn); filterArticles(); };
  sourceScroller.appendChild(allBtn);

  sources.forEach(src => {
    const btn = document.createElement('button');
    btn.textContent = src.name.replace(/ London$/, '');
    btn.onclick = () => { filter = src.name; switchActive(btn); filterArticles(); };
    sourceScroller.appendChild(btn);
  });
}

function switchActive(activeBtn) {
  sourceScroller.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
  activeBtn.classList.add('active');
}

function filterArticles() {
  document.querySelectorAll('.card').forEach(card => {
    card.style.display = filter === 'all' || card.dataset.source === filter ? '' : 'none';
  });
}

async function fetchAndRender(sources) {
  newsFeed.innerHTML = '';
  const groups = await Promise.all(sources.map(async src => {
    try {
      const res = await fetch(src.url);
      const data = await res.json();
      return (data.items || []).map(item => ({
        title: item.title,
        link: item.link,
        date: new Date(item.pubDate),
        source: src.name,
        thumbnail: item.thumbnail || '',
        content: (item.content || item.description || '').replace(/<img[^>]*>/g, '').replace(/<\/?a[^>]*>/g, '')
      }));
    } catch {
      return [];
    }
  }));

  const articles = groups.flat().sort((a,b) => b.date - a.date);
  const buffer = [...articles];
  while (buffer.length) {
    const head = buffer.shift();
    const related = buffer.filter(x => x.title.toLowerCase().includes(head.title.toLowerCase()));
    buffer = buffer.filter(x => !related.includes(x));

    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.source = head.source;

    const id = btoa(head.link);
    if (readSet.has(id)) card.classList.add('read');

    card.innerHTML = `
      <img src="${head.thumbnail}" alt="">
      <div class="read-icon"><i class='bx bxs-check-circle'></i></div>
      <div class="card-content">
        <h2>${head.title}</h2>
        <div class="meta">${head.source} • ${head.date.toLocaleDateString()}</div>
        <div class="full-content">
          ${head.content}<br>
          <a href="${head.link}" class="read-more" target="_blank">Read full article</a>
          ${related.length ? '<div class="related"><strong>Related:</strong>' +
            related.map(r => `<a href="${r.link}" target="_blank">${r.source} — ${r.date.toLocaleDateString()}</a>`).join('') +
          '</div>' : ''}
        </div>
      </div>`;

    card.onclick = e => {
      if (e.target.tagName !== 'A') {
        const expanded = card.classList.toggle('expanded');
        if (expanded) {
          card.scrollIntoView({behavior:'smooth', block:'start'});
          saveRead(id);
          card.classList.add('read');
        }
      }
    };

    newsFeed.appendChild(card);
  }

  filterArticles();
}

function loadAll() {
  const opts = Array.from(settingsPanel.querySelectorAll('input:checked')).map(cb => ({
    name: cb.nextSibling.textContent + ' (CBC)',
    url: cb.value
  }));
  const sources = [...defaultSources, ...opts];
  renderSources(sources);
  fetchAndRender(sources);
}

settingsPanel.querySelectorAll('input').forEach(cb => cb.addEventListener('change', loadAll));

loadAll();
</script>

</body>
</html>
