<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>London News</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.ico">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
<style>
  /* =========================================================
     ROOT VARIABLES & GLOBAL RESETS
  ========================================================= */
  :root {
    --accent: #181526;
    --button: #e8eeff;
    --surface: #1f1f1f;
    --bg: #292a2d;
  }

  * {
    box-sizing: border-box;
  }

  html, body {
    height: 100%;
  }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: #fff;
    margin: 0;
    padding: env(safe-area-inset-top) 1.5rem env(safe-area-inset-bottom);
  }

  /* =========================================================
     PAGE HEADER (Date / Title)
  ========================================================= */
  .page-top {
    padding: 1rem 0 0.25rem;
  }

  .page-top h1 {
    font-size: 1.5rem;
    font-weight: 800;
    margin: 0;
  }

  .page-top .date {
    opacity: 0.8;
    font-weight: 900;
    margin-top: 0.25rem;
    margin-bottom: 0.75rem;
    font-size: 1.5rem;
  }

  /* =========================================================
     SOURCE SCROLLER
  ========================================================= */
  .source-scroller-wrapper {
    overflow-x: auto;
    margin: 0 -1.5rem 1rem;
    padding: 0 1.5rem;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .source-scroller-wrapper::-webkit-scrollbar {
    display: none;
  }

  .source-scroller {
    display: flex;
    gap: 0.75rem;
    min-width: max-content;
  }

  .source-scroller::after {
    content: "";
    flex: 0 0 1.5rem;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--surface);
    border: none;
    border-radius: 20px;
    padding: 0.5rem 0.9rem;
    font-weight: 700;
    font-size: 0.95rem;
    color: #fff;
    white-space: nowrap;
    cursor: pointer;
    transition: transform 0.06s ease;
  }

  .chip:active {
    transform: translateY(1px);
  }

  .chip img,
  .chip i {
    height: 28px;
    width: 28px;
    border-radius: 50%;
    object-fit: contain;
    display: block;
    flex-shrink: 0;
  }

  .chip i {
    display: grid;
    place-items: center;
    font-size: 1.1rem;
  }

  .chip.active {
    background-color: #292a2d;
    box-shadow: 0 0 0 2px #1f1f1f inset;
  }

  /* =========================================================
     FEED GRID
  ========================================================= */
.feed {
  /* Masonry via CSS columns */
  column-width: 340px;        /* target column width */
  column-gap: 1.5rem;         /* same spacing you already use */
  padding-bottom: 150px;
}

@supports not (grid-template-rows: masonry) {
  .feed {
    display: masonry;
    column-gap: 1.5rem;
  }
  .card {
    break-inside: avoid;
    margin-bottom: 1.5rem;
  }
}
/* Make cards flow inside columns like masonry items */
.card {
  display: inline-block;      /* required for column masonry */
  width: 100%;
  margin: 0 0 1.5rem;         /* vertical gap between items */
  vertical-align: top;
  transition: transform 0.25s ease, opacity 0.25s ease; /* optional nicety */
}

.card { break-inside: avoid; }  /* prevent splitting across columns */

/* Optional: tighten single-column on very small screens */
@media (max-width: 700px) {
  .feed { column-width: 320px; }
}


  /* =========================================================
     CARD BASE STYLES
  ========================================================= */
  .card {
    background: var(--surface);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: max-height 0.3s ease;
    display: flex;
    flex-direction: column;
    position: relative;
    cursor: pointer;

    /* fixes gradient stretching */
    background-size: 100% 340px;
    background-repeat: no-repeat;
    background-position: top;
	background-attachment: fixed;
  }

  .card.expanded {
    max-height: 1000px;
  }

  /* =========================================================
     NO-IMAGE CARDS (uses unified gradient background)
  ========================================================= */
.card.no-image {
  background-color: var(--source-color, #5e0f0f);
  position: relative;
}


.card.no-image .card-content {
  padding: 1rem;
}

  /* =========================================================
     IMAGE WRAPPER
  ========================================================= */
  .card-image-wrapper {
    position: relative;
    width: 100%;
    height: 210px;
    overflow: hidden;
  }

  .card-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
.card-image-wrapper::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 100%;
  background: linear-gradient(
    to top,
    var(--source-color, #1f1f1f) 0%,
    color-mix(in srgb, var(--source-color, #1f1f1f) 85%, black 15%) 10%,
    rgba(0, 0, 0, 0.25) 25%,
    rgba(0, 0, 0, 0.1) 40%,
    rgba(0, 0, 0, 0) 60%
  );
  pointer-events: none;
  z-index: 1;
}





	/* =========================================================
	   CARD GRADIENT OVERLAY (dynamic darker-to-transparent layer)
	========================================================= */

.card-gradient-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 210px; /* lock gradient to image area height */
  z-index: 0;

  background-attachment: fixed;
  mix-blend-mode: multiply;
  pointer-events: none;
}

.card > *:not(.card-gradient-overlay) {
  position: relative;
  z-index: 1;
}




  /* =========================================================
     CARD HEADER (source name + timestamp)
  ========================================================= */
  .card-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.6rem 0.9rem;
    font-size: 0.8rem;
    color: #fff;
    z-index: 2;
  }

  .source-logo-name {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 700;
  }

  .source-logo-name img {
    height: 32px;
    width: 32px;
    border-radius: 50%;
    object-fit: contain;
  }

  .timestamp {
    font-weight: 700;
  }

  /* =========================================================
     CARD CONTENT (title + body)
  ========================================================= */
  .card-content {
    padding: 1rem;
    display: flex;
    flex-direction: column;
  }

  .card-content h2 {
    font-size: 1.2rem;
    margin: 0 0 0.5rem;
    font-weight: 800;
    color: #fff;
  }

  .full-content {
    font-size: 1rem;
    line-height: 1.6;
    color: #e8eeff;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    margin-top: 0;
    transition: max-height 0.3s ease, opacity 0.4s ease, margin-top 0.4s ease;
  }

  .card.expanded .full-content {
    max-height: 400px;
    opacity: 1;
    margin-top: 0.75rem;
  }

  .read-more {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    background: var(--button);
    color: var(--accent);
    padding: 0.5rem 1rem;
    text-decoration: none;
    border-radius: 20px;
    font-weight: 700;
    width: fit-content;
    font-size: 1rem;
  }

  /* =========================================================
     BOTTOM HEADER (FROSTED NAV BAR)
  ========================================================= */
  header {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 900;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    background: rgba(70,70,70,0.6);
    padding: 1rem max(1.5rem, env(safe-area-inset-left, 0px))
             calc(1rem + env(safe-area-inset-bottom, 0px))
             max(1.5rem, env(safe-area-inset-right, 0px));
    border-top: 1px solid rgba(255,255,255,0.06);
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 90px;
  }

  header .brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  header .brand h1 {
    font-size: 1.25rem;
    font-weight: 900;
    margin: 0;
  }

  /* =========================================================
     NAV BUTTONS (refresh / back to top)
  ========================================================= */
  #refreshBtn,
  #backToTopBtn {
    background: none;
    border: 0;
    color: #fff;
    font-size: 1.75rem;
    cursor: pointer;
    display: grid;
    place-items: center;
    transition: transform 0.3s ease;
  }

  #backToTopBtn {
    font-size: 1.6rem;
  }

  #refreshBtn:hover,
  #backToTopBtn:hover {
    transform: scale(1.1);
  }

  .bx-spin-reverse {
    animation: spinReverse 1s linear infinite;
  }

  @keyframes spinReverse {
    from { transform: rotate(0deg); }
    to { transform: rotate(-360deg); }
  }

  /* =========================================================
     EMPTY STATE
  ========================================================= */
  .empty-state {
    background: var(--surface);
    border-radius: 20px;
    padding: 3rem 1rem;
    margin: 2rem auto;
    max-width: 400px;
    text-align: center;
    color: #e8eeff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }

  .empty-state i {
    font-size: 3rem;
    color: #3c7a41;
    margin-bottom: 1rem;
  }

  .empty-state p {
    font-size: 1.4rem;
    font-weight: 800;
    margin: 0.25rem 0;
  }

  .empty-state span {
    font-size: 1rem;
    color: #aeafb1;
  }
  
.topic-title {
  display: flex;
  align-items: flex-end;       /* top align the sticker with the title */
  gap: 0.6rem;
  margin-bottom: 0.4rem;
}

.topic-title h2 {
  margin: 0;
  flex: 1;                       /* lets title wrap beside the emoji */
  font-size: 1.2rem;
  font-weight: 800;
  color: #fff;
  line-height: 1.3;
  word-break: break-word;
}

/* Sticker-style emoji */
.topic-title .emoji {
  font-size: 2.8rem;
  flex-shrink: 0;
  position: relative;
  top: 0.5rem;
}



  
</style>

</head>
<body>
  <div class="page-top">
    <div class="date" id="currentDate"></div>
  </div>

  <div class="source-scroller-wrapper">
    <div class="source-scroller" id="sourceScroller"></div>
  </div>

  <div class="feed" id="newsFeed"></div>

<header>
  <div class="brand">
    <i class='bx bx-news' style="font-size:1.6rem;"></i>
    <h1>London News</h1>
  </div>
  <div style="display:flex; gap:1rem;">
    <button id="backToTopBtn" aria-label="Back to top">
      <i class='bx bx-up-arrow-alt'></i>
    </button>
    <button id="refreshBtn" aria-label="Refresh">
      <i class='bx bx-refresh'></i>
    </button>
  </div>
</header>


<script>
  const PEXELS_API_KEY = 'fB6vzEHx5CsDIVByIpuDfQ2QoliM9TYWyBqmkzPgj6nPeEuWdBvbtJIx';
  const feedContainer = document.getElementById("newsFeed");
  const sourceScroller = document.getElementById("sourceScroller");

  const state = {
    filters: { source: 'all' },
    articles: [],
    allSources: []
  };

  // Set date at top of page
  (function setDate(){
    const el = document.getElementById("currentDate");
    const today = new Date();
    el.textContent = today.toLocaleDateString("en-US", {
      year: "numeric", month: "long", day: "numeric"
    });
  })();

  // Toast element for update message
  const toast = document.createElement("div");
  toast.style.position = "fixed";
  toast.style.bottom = "110px";
  toast.style.left = "50%";
  toast.style.transform = "translateX(-50%)";
  toast.style.background = "rgba(255,255,255,0.1)";
  toast.style.backdropFilter = "blur(10px)";
  toast.style.border = "1px solid rgba(255,255,255,0.2)";
  toast.style.color = "#fff";
  toast.style.padding = "0.6rem 1.2rem";
  toast.style.borderRadius = "20px";
  toast.style.fontWeight = "700";
  toast.style.opacity = "0";
  toast.style.transition = "opacity 0.4s ease";
  toast.style.zIndex = "9999";
  toast.textContent = "Updated just now";
  document.body.appendChild(toast);

  function showToast(message = "Updated just now") {
    toast.textContent = message;
    toast.style.opacity = "1";
    setTimeout(() => (toast.style.opacity = "0"), 2500);
  }

  // Utilities
  function stripHtmlTags(html) {
    if (!html) return '';
    const txt = document.createElement('textarea');
    txt.innerHTML = html;
    let decoded = txt.value;
    decoded = decoded.replace(/<a[^>]*>(.*?)<\/a>/gi, '$1');
    decoded = decoded.replace(/<\/?[^>]+(>|$)/g, '');
    decoded = decoded.replace(/\s+/g, ' ').trim();
    return decoded;
  }

  function truncateWords(text, wordLimit) {
    const words = (text || '').trim().split(/\s+/);
    return words.length > wordLimit ? words.slice(0, wordLimit).join(" ") + "…" : text;
  }

  function formatArticleDate(pubDate) {
    const date = new Date(pubDate);
    const time = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
    const today = new Date();
    const articleDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const todayDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const diff = todayDay - articleDay;
    const oneDay = 86400000;
    if (diff === 0) return time;
    if (diff === oneDay) return `Yesterday • ${time}`;
    return date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
  }
  
// =========================================================
// SMART TOPIC + EMOJI MAPPING (London News edition)
// =========================================================
const TOPIC_EMOJIS = {
  "sports": "🏒",
  "crime": "🚔",
  "health": "🏥",
  "politics": "🏛️",
  "education": "🎓",
  "weather": "🌧️",
  "local": "🏙️",
  "business": "💼",
  "culture": "🎨",
  "arts": "🎭",
  "entertainment": "🎬",
  "science": "🔬",
  "technology": "💻",
  "environment": "🌿",
  "power": "⚡",
  "future": "🔮",
  "food": "🍽️",
  "animals": "🐾",
  "transportation": "🚗",
  "housing": "🏠",
  "fire": "🔥",
  "event": "🎪",
  "community": "🤝",
  "finance": "💰",
  "crime_police": "🚨",
  "religion": "⛪",
  "default": "📰"
};


// =========================================================
// INTELLIGENT TOPIC INFERENCE (based on article title)
// =========================================================
function inferTopic(item) {
  const title = (item.title || "").toLowerCase();

  // SPORTS
  if (title.match(/\b(jays|leafs|knights|ohl|game|score|win|loss|goal|team|mustangs|hockey|football|sports|marathon|championship|argonauts|stampeders|bullpen)\b/))
    return "sports";

  // CRIME & POLICE
  if (title.match(/\b(police|charged|arrest|investigation|shooting|murder|stabbing|suspect|opp|court|crime|assault|collision|crash|impaired|drugs|seized|trafficking|homicide|break-and-enter|wanted|fentanyl|charges)\b/))
    return "crime";

  // HEALTH
  if (title.match(/\b(hospital|covid|health|mental|care|patient|doctor|nurse|disease|illness|virus|vaccine|measles|outbreak|clinic|wellness|medical)\b/))
    return "health";

  // POLITICS / GOVERNMENT
  if (title.match(/\b(mayor|council|election|government|politics|minister|city hall|funding|budget|policy|federal|provincial|politician|bill|legislation|mp|mpp|parliament)\b/))
    return "politics";

  // EDUCATION / TECH TRENDS
  if (title.match(/\b(school|student|college|university|teacher|education|principal|tiktok|social media|online safety|copycat|trend|cyber|technology|internet|digital|ai|artificial intelligence)\b/))
    return "education";

  // WEATHER / ENVIRONMENT / CLIMATE
  if (title.match(/\b(storm|snow|rain|weather|forecast|sunny|temperature|wind|climate|environment|wildfire|heatwave|tree|planting|seedling|ltvca|conservation|forest|green|sustainability|carbon)\b/))
    return "environment";

  // BUSINESS / ECONOMY / JOBS
  if (title.match(/\b(business|bank|market|job|economy|investment|funding|profit|company|employment|layoff|money|financial|goods|manufacturing|shelves|locally-made|trade)\b/))
    return "business";

  // CULTURE / ARTS / ENTERTAINMENT / BOOKS
  if (title.match(/\b(festival|concert|art|music|movie|film|show|performance|theatre|gallery|culture|comedy|book|author|write|media|tv|series|drama|entertainment|creative|comics|literature)\b/))
    return "culture";

  // FOOD
  if (title.match(/\b(food|restaurant|menu|chef|dine|eatery|coffee|chocolate|drink|cafe|bake|culinary)\b/))
    return "food";

  // COMMUNITY / EVENTS / CHARITY
  if (title.match(/\b(local|london|londoner|londoners|downtown|community|neighbourhood|event|festival|fundraiser|volunteer|giveaway|donation|motionball|charity|campaign|rally|initiative|celebrate|coat|goodwill)\b/))
    return "community";

  // FIRE / EMERGENCY
  if (title.match(/\b(fire|blaze|rescue|structure fire|house fire|burned|flames|crews dispatched)\b/))
    return "fire";

  // HOUSING / DEVELOPMENT / INFRASTRUCTURE
  if (title.match(/\b(housing|rent|condo|home|apartment|real estate|development|construction|affordable|project|building|loophole)\b/))
    return "housing";

  // TRANSPORTATION / BORDER / TRAVEL
  if (title.match(/\b(road|highway|traffic|train|transit|bus|closure|border|airport|customs|travel|passport|inspection|flight)\b/))
    return "transportation";

  // SCIENCE / TECHNOLOGY / FUTURE
  if (title.match(/\b(science|research|innovation|ai|artificial intelligence|technology|robot|future|data|digital|device|cyber)\b/))
    return title.includes("future") ? "future" : "technology";

  // ANIMALS / WILDLIFE
  if (title.match(/\b(animal|dog|cat|wildlife|bird|pet|swan|zoo|species)\b/))
    return "animals";

  // RELIGION / FAITH
  if (title.match(/\b(church|temple|faith|religion|mosque|prayer)\b/))
    return "religion";

  return "default";
}



  

  async function getPexelsImage(query) {
    try {
      const res = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=1`, {
        headers: { Authorization: PEXELS_API_KEY }
      });
      const data = await res.json();
      return data.photos?.[0]?.src?.landscape || null;
    } catch {
      return null;
    }
  }

  // Card builder
  function createCard(item, source) {
    const id = btoa(item.link);
    if (state.articles.some(a => a.id === id)) return null;

    item.pubDate ||= item.isoDate || item.published || item.date || new Date().toISOString();
    const timeString = formatArticleDate(item.pubDate);
	
	// infer topic + emoji
	const topic = inferTopic(item);
	const emoji = TOPIC_EMOJIS[topic] || TOPIC_EMOJIS.default;
	item.topic = topic;
	item.emoji = emoji;
	

    const card = document.createElement("div");
    card.className = "card";
    card.dataset.id = id;
    card.dataset.source = source.name;

const hasImage = item.thumbnail && !item.thumbnail.includes('placehold.co');
let imageSection = '';

if (hasImage) {
  imageSection = `
    <div class="card-image-wrapper">
      <img src="${item.thumbnail}" alt="thumbnail" loading="lazy">
    </div>`;
} else {
  imageSection = ''; // no image section at all
}

card.className = hasImage ? "card" : "card no-image";
card.dataset.id = id;
card.dataset.source = source.name;

card.innerHTML = `
  ${imageSection}
  <div class="card-header">
    <div class="source-logo-name">
      ${source.logo ? `<img src="${source.logo}" alt="${source.name}" onerror="this.style.display='none';">` : ''}
      <span>${source.name}</span>
    </div>
    <div class="timestamp">${timeString}</div>
  </div>
<div class="card-content">
  <div class="topic-title">
    <h2>${truncateWords(item.title, 15)}</h2>
    <span class="emoji">${emoji}</span>
  </div>
  
  <div class="full-content">
    ${truncateWords(stripHtmlTags(item.content || item.description || '').replace(/Read More/gi, '').trim(), 40)}<br>
    <a href="${item.link}" class="read-more" target="_blank" rel="noopener">
      Read full article <i class='bx bx-right-arrow-alt'></i>
    </a>
  </div>
</div>
`;



    card.addEventListener("click", (e) => {
      if (e.target.tagName === "A") return;
      const expanded = document.querySelector(".card.expanded");
      if (expanded && expanded !== card) expanded.classList.remove("expanded");
      card.classList.toggle("expanded");
    });

    return { ...item, card, id };
  }

  function renderFeed() {
    feedContainer.innerHTML = '';
    const filtered = state.articles.filter(a =>
      state.filters.source === 'all' || a.card.dataset.source === state.filters.source
    );

    if (filtered.length === 0) {
      feedContainer.innerHTML = `
        <div class="empty-state">
          <i class='bx bx-news'></i>
          <p>No stories.</p>
          <span>Try refreshing.</span>
        </div>`;
      return;
    }

// Sort newest → oldest
const sorted = filtered.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

// Create a new array that simulates left→right, top→bottom reading order
const columns = Math.max(1, Math.floor(feedContainer.offsetWidth / 360));

const ordered = [];

for (let i = 0; i < sorted.length; i++) {
  const colIndex = i % columns;
  const rowIndex = Math.floor(i / columns);
  if (!ordered[rowIndex]) ordered[rowIndex] = [];
  ordered[rowIndex][colIndex] = sorted[i];
}

// Flatten row-major order into a single array
ordered.flat().forEach(item => feedContainer.appendChild(item.card));


    applyDynamicCardColors();
  }

function applyDynamicCardColors() {
  const colorThief = new ColorThief();
  const cards = document.querySelectorAll('.card img');

  cards.forEach(img => {
    if (img.complete) setColor(img);
    else img.addEventListener('load', () => setColor(img));
  });

  function setColor(img) {
    try {
      const [r, g, b] = colorThief.getColor(img);
      const [adjR, adjG, adjB] = adjustForContrast(r, g, b);

      // Define readable variables for the two colours
      const sourceColor = `rgb(${adjR}, ${adjG}, ${adjB})`;
      const darkSourceColor = `rgb(${Math.max(adjR - 40, 0)}, ${Math.max(adjG - 40, 0)}, ${Math.max(adjB - 40, 0)})`;

      const card = img.closest('.card');

      // Set the solid base colour
      card.style.backgroundColor = sourceColor;

      // Overlay darker-to-transparent gradient
      const overlay = document.createElement("div");
      overlay.className = "card-gradient-overlay";
      overlay.style.position = "absolute";
      overlay.style.inset = "0";
      overlay.style.pointerEvents = "none";
if (img.closest('.card') && !img.closest('.card').classList.contains('no-image')) {
  overlay.style.background = `
    linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 35%),
    linear-gradient(to top, ${darkSourceColor} 0%, rgba(0,0,0,0) 60%)
  `;
} else {
  overlay.style.background = `linear-gradient(180deg, ${darkSourceColor} 0%, rgba(0,0,0,0) 100%)`;
}


      // Save readable colour variables on the card
      card.style.setProperty("--source-color", sourceColor);
      card.style.setProperty("--dark-source-color", darkSourceColor);

      // Remove any previous overlays before adding
      const oldOverlay = card.querySelector(".card-gradient-overlay");
      if (oldOverlay) oldOverlay.remove();
      card.insertBefore(overlay, card.firstChild);


    } catch (err) {
      console.warn("Color extraction failed for", img.src, err);
    }
  }

  function adjustForContrast(r, g, b) {
    let brightness = (0.299 * r + 0.587 * g + 0.114 * b);
    if (brightness > 160) {
      const factor = 160 / brightness;
      r = Math.round(r * factor);
      g = Math.round(g * factor);
      b = Math.round(b * factor);
    }
    const avg = (r + g + b) / 3;
    r = Math.round((r + avg) / 2);
    g = Math.round((g + avg) / 2);
    b = Math.round((b + avg) / 2);
    return [r, g, b];
  }
}


  function generatePlaceholderFromLogoColor(logoUrl, sourceName) {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.src = logoUrl;
      img.onload = () => {
        try {
          const colorThief = new ColorThief();
          const [r, g, b] = colorThief.getColor(img);
          const darken = 0.55;
          const dr = Math.round(r * darken);
          const dg = Math.round(g * darken);
          const db = Math.round(b * darken);
          const bgColor = `${dr.toString(16).padStart(2, '0')}${dg
            .toString(16)
            .padStart(2, '0')}${db.toString(16).padStart(2, '0')}`;
          const text = encodeURIComponent(sourceName);
          resolve(`https://placehold.co/800x400/${bgColor}/ffffff?text=${text}`);
        } catch (err) {
          resolve(`https://placehold.co/800x400/1f1f1f/ffffff?text=${encodeURIComponent(sourceName)}`);
        }
      };
      img.onerror = () => {
        resolve(`https://placehold.co/800x400/1f1f1f/ffffff?text=${encodeURIComponent(sourceName)}`);
      };
    });
  }

  function buildSourceScroller(sources) {
    sourceScroller.innerHTML = '';
    const allBtn = document.createElement('button');
    allBtn.className = 'chip active';
    allBtn.innerHTML = `<i class='bx bx-globe'></i><span>All</span>`;
    allBtn.onclick = () => {
      state.filters.source = 'all';
      [...sourceScroller.querySelectorAll('.chip')].forEach(b => b.classList.remove('active'));
      allBtn.classList.add('active');
      renderFeed();
    };
    sourceScroller.appendChild(allBtn);

    sources.forEach(source => {
      const btn = document.createElement('button');
      btn.className = 'chip';
      btn.innerHTML = source.logo
        ? `<img src="${source.logo}" alt="${source.name}"><span>${source.name}</span>`
        : `<i class='bx bx-news'></i><span>${source.name}</span>`;
      btn.onclick = () => {
        state.filters.source = source.name;
        [...sourceScroller.querySelectorAll('.chip')].forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderFeed();
      };
      sourceScroller.appendChild(btn);
    });
  }

  async function loadFeed(source) {
    const cachedUrl = `https://rss-proxy.davidbusch-02.workers.dev/cached?url=${encodeURIComponent(source.url)}`;
    const liveUrl   = `https://rss-proxy.davidbusch-02.workers.dev/?url=${encodeURIComponent(source.url)}`;
    let data = null;

    try {
      const cachedRes = await fetch(cachedUrl);
      if (cachedRes.ok) data = await cachedRes.json();
    } catch {}

    if (!data || !data.items || data.items.length === 0) {
      const liveRes = await fetch(liveUrl);
      data = await liveRes.json();
    }
    if (!data.items) return;

    for (const item of data.items) {
      if (!item.thumbnail) {
        item.thumbnail = await generatePlaceholderFromLogoColor(source.logo, source.name);
      }
      const entry = createCard(item, source);
      if (entry) state.articles.push(entry);
    }
  }

  // Try cached feed instantly
  const saved = localStorage.getItem('feedCache');
  const savedAt = localStorage.getItem('feedTimestamp');
  if (saved && savedAt && Date.now() - savedAt < 1000 * 60 * 30) {
    try {
      state.articles = JSON.parse(saved);
      renderFeed();
      console.log("Loaded feed from local cache");
    } catch (e) {
      console.warn("Local cache corrupted, refetching");
    }
  }

  async function loadAllFeeds() {
    feedContainer.innerHTML = `
      <div class="empty-state">
        <i class='bx bx-loader bx-spin'></i>
        <p>Loading feeds…</p>
      </div>`;
    state.articles = [];

    try {
      const feedRes = await fetch("feeds.json");
      const feedData = await feedRes.json();
      state.allSources = Object.values(feedData).flat();
      buildSourceScroller(state.allSources);
      await Promise.all(state.allSources.map(loadFeed));
      renderFeed();
      localStorage.setItem('feedCache', JSON.stringify(state.articles));
      localStorage.setItem('feedTimestamp', Date.now());
      showToast();
    } catch (err) {
      feedContainer.innerHTML = `
        <div class="empty-state">
          <i class='bx bx-error'></i>
          <p>Error loading feeds</p>
          <span>${err.message}</span>
        </div>`;
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', async () => {
    const icon = document.querySelector('#refreshBtn i');
    icon.classList.add('bx-spin-reverse');
    await loadAllFeeds();
    icon.classList.remove('bx-spin-reverse');
  });

  document.getElementById('backToTopBtn').addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  const backToTopBtn = document.getElementById('backToTopBtn');
  window.addEventListener('scroll', () => {
    backToTopBtn.style.opacity = window.scrollY > 400 ? '1' : '0';
    backToTopBtn.style.pointerEvents = window.scrollY > 400 ? 'auto' : 'none';
  });
  backToTopBtn.style.transition = 'opacity 0.3s ease';
  backToTopBtn.style.opacity = '0';
  backToTopBtn.style.pointerEvents = 'none';

  loadAllFeeds();
</script>

<script src="https://unpkg.com/colorthief/dist/color-thief.umd.js"></script>


</body>
</html>