<!DOCTYPE html>
<html lang="en" class="scroll-smooth antialiased">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#000000">
    <title>TubeRaider</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Outfit', 'system-ui', 'sans-serif'],
            },
            colors: {
              black: '#000000',
              dark: '#0a0a0a',
              surface: '#161616',
              accent: '#26b58b', 
              gold: '#eebc51',
              red: '#e50914',
              subtle: '#a3a3a3',
            },
            boxShadow: {
              'premium': '0 20px 40px -10px rgba(0,0,0,0.5)',
              'glow-accent': '0 0 40px -10px rgba(38, 181, 139, 0.2)',
            }
          }
        }
      }
    </script>

    <style>
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .touch-scroll { -webkit-overflow-scrolling: touch; }
      .aspect-video { aspect-ratio: 16 / 9; }
      
      /* Video Background Wrapper */
      .hero-video-container {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        overflow: hidden;
        z-index: 0;
      }
      /* Force iframe to fill and crop */
      .hero-video-container iframe {
        position: absolute;
        top: 50%; left: 50%;
        width: 100vw; height: 56.25vw; /* 16:9 ratio based on width */
        min-height: 100vh; min-width: 177.77vh; /* 16:9 ratio based on height */
        transform: translate(-50%, -50%) scale(1.3); /* Scale slightly to hide controls/bars */
        pointer-events: none;
      }
    </style>
  </head>
  <body class="bg-black text-white font-sans min-h-screen relative overflow-x-hidden selection:bg-accent selection:text-black">

    <!-- HEADER -->
    <header class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 bg-gradient-to-b from-black/90 via-black/50 to-transparent" id="navbar">
      <div class="w-full px-6 md:px-12 h-24 flex items-center justify-between">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="window.scrollTo({top:0, behavior:'smooth'})">
          <div class="w-10 h-10 rounded-xl bg-white/10 backdrop-blur-sm flex items-center justify-center border border-white/10 text-white font-extrabold text-sm tracking-tighter group-hover:bg-accent group-hover:text-black transition-colors duration-300">TR</div>
          <span class="font-extrabold text-xl tracking-[0.2em] uppercase opacity-90 group-hover:opacity-100 transition-opacity drop-shadow-md">TubeRaider</span>
        </div>

        <div class="flex items-center">
           <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-black/60 border border-white/10 backdrop-blur-md text-[10px] font-bold uppercase tracking-widest text-subtle shadow-lg" id="header-updated">
             <i class="ph-fill ph-circle text-accent animate-pulse"></i> Live
           </div>
        </div>
      </div>
    </header>

    <!-- HERO SECTION -->
    <div class="relative w-full h-[85vh] flex items-end bg-dark overflow-hidden">
      
      <!-- Video Background -->
      <div class="hero-video-container opacity-60 mix-blend-lighten transition-opacity duration-1000" id="hero-bg">
         <!-- Fallback static image until video loads -->
         <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1518546305927-5a555bb7020d?q=80&w=2940')] bg-cover bg-center"></div>
      </div>
      
      <!-- Gradients for Text Readability -->
      <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent z-10"></div>
      <div class="absolute inset-0 bg-gradient-to-r from-black/80 via-transparent to-transparent z-10"></div>

      <!-- Hero Text Content -->
      <div class="relative z-20 w-full max-w-[1600px] mx-auto px-6 md:px-12 pb-24 md:pb-32 flex flex-col justify-end h-full pointer-events-none">
        <div class="max-w-4xl pointer-events-auto">
          
          <div class="flex items-center gap-3 mb-6">
             <span class="px-2 py-1 bg-accent text-black text-[10px] font-black uppercase tracking-widest rounded-sm">Featured</span>
             <span class="px-2 py-1 bg-white/10 text-white border border-white/20 text-[10px] font-bold uppercase tracking-widest rounded-sm backdrop-blur-md">Collection</span>
          </div>

          <h1 class="text-6xl md:text-8xl lg:text-9xl font-black tracking-tighter leading-[0.9] mb-6 text-white drop-shadow-2xl">
            TubeRaider
          </h1>
          
          <p class="text-lg md:text-2xl text-gray-200 font-light leading-relaxed max-w-2xl mb-10 drop-shadow-lg text-pretty">
            Discover the latest walkthroughs, trailers, speedruns, and curated content from the entire Tomb Raider universe.
          </p>
          
          <div class="flex items-center gap-4">
            <button onclick="document.getElementById('content-start').scrollIntoView({behavior: 'smooth'})" class="bg-white text-black h-14 px-10 rounded font-bold text-sm uppercase tracking-widest hover:bg-accent hover:scale-105 transition-all duration-300 shadow-[0_0_30px_rgba(255,255,255,0.3)] flex items-center gap-3 group">
              <i class="ph-fill ph-play text-xl group-hover:animate-pulse"></i> Start Watching
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="content-start" class="relative z-20 bg-black min-h-screen pb-20 -mt-2">
      
      <!-- Filter Bar -->
      <div class="px-6 md:px-12 py-8 md:py-12 border-b border-white/5 mb-12 bg-black">
        <div class="flex flex-nowrap overflow-x-auto no-scrollbar gap-3 md:gap-4 pb-2" id="filters">
          <!-- Filters injected via JS -->
        </div>
      </div>

      <div class="max-w-[1800px] mx-auto space-y-20 md:space-y-32">
        
        <!-- 1. MOST VIEWED -->
        <section id="section-most-viewed" class="px-6 md:px-12 group/section">
          <div class="flex items-end justify-between mb-6 md:mb-8 border-l-4 border-accent pl-4">
            <h2 class="text-2xl md:text-4xl font-bold text-white tracking-tight">Most Viewed</h2>
            <div class="flex gap-2 opacity-60 group-hover/section:opacity-100 transition-opacity duration-300" id="most-viewed-sort">
               <button class="text-[10px] font-bold uppercase tracking-widest px-4 py-2 border border-white/20 rounded hover:bg-white hover:text-black transition-colors data-[active=true]:bg-white data-[active=true]:text-black" data-timeframe="allTime" data-active="true">All Time</button>
               <button class="text-[10px] font-bold uppercase tracking-widest px-4 py-2 border border-white/20 rounded hover:bg-white hover:text-black transition-colors data-[active=true]:bg-white data-[active=true]:text-black" data-timeframe="week">Week</button>
            </div>
          </div>
          
          <div class="relative group/slider">
             <div class="flex overflow-x-auto gap-5 pb-12 -mx-6 px-6 md:mx-0 md:px-0 no-scrollbar touch-scroll scroll-pl-6" id="most-viewed-container">
               <!-- Cards Injected Here -->
             </div>
             <div class="absolute right-0 top-0 bottom-12 w-40 bg-gradient-to-l from-black to-transparent pointer-events-none z-10 hidden md:block"></div>
          </div>
        </section>

        <!-- 2. TRENDING -->
        <section id="section-trending" class="px-6 md:px-12 group/section">
          <div class="flex items-end justify-between mb-6 md:mb-8 border-l-4 border-gold pl-4">
            <h2 class="text-2xl md:text-4xl font-bold text-white tracking-tight flex items-center gap-3">
              Trending <i class="ph-fill ph-trend-up text-gold text-2xl"></i>
            </h2>
            <div class="flex gap-2 opacity-60 group-hover/section:opacity-100 transition-opacity duration-300" id="trending-sort">
               <button class="text-[10px] font-bold uppercase tracking-widest px-4 py-2 border border-white/20 rounded hover:bg-white hover:text-black transition-colors data-[active=true]:bg-white data-[active=true]:text-black" data-timeframe="week" data-active="true">Week</button>
               <button class="text-[10px] font-bold uppercase tracking-widest px-4 py-2 border border-white/20 rounded hover:bg-white hover:text-black transition-colors data-[active=true]:bg-white data-[active=true]:text-black" data-timeframe="today">Today</button>
            </div>
          </div>
          <div class="relative group/slider">
             <div class="flex overflow-x-auto gap-5 pb-12 -mx-6 px-6 md:mx-0 md:px-0 no-scrollbar touch-scroll scroll-pl-6" id="trending-container"></div>
          </div>
        </section>

        <!-- 3. LIVE -->
        <section id="section-live" class="px-6 md:px-12 group/section hidden">
          <div class="flex items-center gap-4 mb-6 md:mb-8 border-l-4 border-red pl-4">
            <h2 class="text-2xl md:text-4xl font-bold text-white tracking-tight">Live Now</h2>
            <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red"></span></span>
          </div>
          <div class="relative group/slider">
             <div class="flex overflow-x-auto gap-5 pb-12 -mx-6 px-6 md:mx-0 md:px-0 no-scrollbar touch-scroll scroll-pl-6" id="live-container"></div>
          </div>
        </section>

        <!-- 4. LATEST -->
        <section id="section-latest" class="px-6 md:px-12 group/section">
          <div class="flex items-end justify-between mb-6 md:mb-8 border-l-4 border-white pl-4">
            <h2 class="text-2xl md:text-4xl font-bold text-white tracking-tight">New Arrivals</h2>
          </div>
          <div class="relative group/slider">
             <div class="flex overflow-x-auto gap-5 pb-12 -mx-6 px-6 md:mx-0 md:px-0 no-scrollbar touch-scroll scroll-pl-6" id="new-container"></div>
          </div>
        </section>

        <!-- 5. SHORTS -->
        <section id="section-shorts" class="px-6 md:px-12 group/section pb-32">
          <div class="flex items-end justify-between mb-6 md:mb-8 border-l-4 border-accent pl-4">
            <h2 class="text-2xl md:text-4xl font-bold text-white tracking-tight flex items-center gap-3">
              Shorts <i class="ph-fill ph-lightning text-accent text-2xl"></i>
            </h2>
            <div class="flex gap-2" id="shorts-sort">
               <button class="text-[10px] font-bold uppercase tracking-widest px-4 py-2 border border-white/20 rounded hover:bg-white hover:text-black transition-colors data-[active=true]:bg-white data-[active=true]:text-black" data-sort="latest" data-active="true">Latest</button>
               <button class="text-[10px] font-bold uppercase tracking-widest px-4 py-2 border border-white/20 rounded hover:bg-white hover:text-black transition-colors data-[active=true]:bg-white data-[active=true]:text-black" data-sort="popular">Popular</button>
            </div>
          </div>
          <div class="relative group/slider">
             <div class="flex overflow-x-auto gap-5 pb-12 -mx-6 px-6 md:mx-0 md:px-0 no-scrollbar touch-scroll scroll-pl-6" id="shorts-container"></div>
          </div>
        </section>

      </div>
    </div>

    <!-- FOOTER -->
    <footer class="border-t border-white/5 py-24 px-6 bg-black text-center">
        <div class="max-w-4xl mx-auto flex flex-col items-center justify-center gap-8">
            <div class="w-16 h-16 rounded-2xl bg-white/5 flex items-center justify-center text-white font-black text-xl tracking-tighter border border-white/5">TR</div>
            <p class="text-subtle text-base leading-relaxed max-w-lg">
              TubeRaider is a community-driven archive dedicated to preserving and showcasing the finest content from the Tomb Raider franchise.
            </p>
            <p class="text-white/20 text-xs font-mono uppercase tracking-widest">Â© 2025 TubeRaider</p>
        </div>
    </footer>

    <!-- VIDEO SHEET (Immersive Layer) -->
    <div id="video-sheet" class="fixed inset-0 z-[100] transform translate-y-full transition-transform duration-500 cubic-bezier(0.19, 1, 0.22, 1) flex flex-col pointer-events-none">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-xl pointer-events-auto transition-opacity duration-500 opacity-0" id="sheet-backdrop" onclick="closeSheet()"></div>
        
        <!-- Sheet Container -->
        <div class="relative flex flex-col w-full h-full bg-[#121212] shadow-2xl overflow-hidden pointer-events-auto mt-0 lg:mt-0 lg:flex-row lg:h-full lg:max-w-[90%] lg:mx-auto lg:rounded-t-2xl border-t border-white/10 lg:border-x">
            
            <!-- Mobile Drag Handle -->
            <div class="w-full flex justify-center pt-3 pb-1 lg:hidden absolute top-0 z-50 bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
                <div class="w-12 h-1.5 rounded-full bg-white/20"></div>
            </div>

            <!-- Video Player -->
            <div class="w-full lg:w-[75%] bg-black relative flex items-center justify-center group h-[35vh] lg:h-full shadow-2xl z-10">
                <div id="video-embed-container" class="w-full h-full bg-black flex items-center justify-center"></div>
            </div>

            <!-- Details Panel -->
            <div class="flex-1 bg-[#121212] lg:border-l border-white/5 flex flex-col h-full relative z-20">
                
                <!-- Sheet Controls -->
                <div class="h-16 px-6 flex items-center justify-between border-b border-white/5 bg-[#121212]/95 backdrop-blur shrink-0">
                    <button onclick="closeSheet()" class="text-subtle hover:text-white transition-colors flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest">
                        <i class="ph-bold ph-arrow-left text-lg"></i> Back
                    </button>
                    <div class="flex gap-4">
                        <button id="sheet-prev" class="text-subtle hover:text-white transition-colors disabled:opacity-30 disabled:cursor-not-allowed"><i class="ph-bold ph-caret-left text-xl"></i></button>
                        <button id="sheet-next" class="text-subtle hover:text-white transition-colors disabled:opacity-30 disabled:cursor-not-allowed"><i class="ph-bold ph-caret-right text-xl"></i></button>
                    </div>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto p-6 md:p-10 no-scrollbar" id="sheet-details">
                    <!-- Dynamic Details -->
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
      // ELEMENTS
      const containers = {
        mostViewed: document.getElementById("most-viewed-container"),
        trending: document.getElementById("trending-container"),
        live: document.getElementById("live-container"),
        latest: document.getElementById("new-container"),
        shorts: document.getElementById("shorts-container"),
      };
      
      const sections = {
        mostViewed: document.getElementById("section-most-viewed"),
        trending: document.getElementById("section-trending"),
        live: document.getElementById("section-live"),
        latest: document.getElementById("section-latest"),
        shorts: document.getElementById("section-shorts"),
      };

      const filtersEl = document.getElementById("filters");
      const videoSheet = document.getElementById("video-sheet");
      const sheetBackdrop = document.getElementById("sheet-backdrop");
      const videoEmbedContainer = document.getElementById("video-embed-container");
      const sheetDetails = document.getElementById("sheet-details");
      const sheetPrev = document.getElementById("sheet-prev");
      const sheetNext = document.getElementById("sheet-next");
      const heroVideoBg = document.getElementById("hero-bg");

      // State
      let dataStore = {
        mostViewed: { today: [], week: [], month: [], allTime: [] },
        trending: { today: [], week: [] },
        newest: [],
        live: [],
        updated: null
      };
      
      let sortState = { mostViewed: 'allTime', trending: 'week', shorts: 'latest' };
      let loadMoreState = { mostViewed: 10, trending: 10, live: 10, newest: 10, shorts: 20 };
      let activeFilter = "all";
      let currentLightboxList = [];
      let currentLightboxIndex = 0;

      const filterOrder = ["all", "live", "walkthrough", "review", "ost", "trailer", "remaster", "speedrun"];
      const filterMeta = {
        all: { label: "All", icon: "ph-sparkle" },
        live: { label: "Live", icon: "ph-broadcast" },
        walkthrough: { label: "Walkthrough", icon: "ph-game-controller" },
        review: { label: "Review", icon: "ph-star" },
        ost: { label: "OST", icon: "ph-music-note" },
        trailer: { label: "Trailer", icon: "ph-film-strip" },
        remaster: { label: "Remaster", icon: "ph-magic-wand" },
        speedrun: { label: "Speedrun", icon: "ph-lightning" }
      };

      // UTILS
      function titleAndDescription(video) { return ((video.snippet?.title || "") + " " + (video.snippet?.description || "")).toLowerCase(); }
      function getDurationInSeconds(d) { if (!d) return 0; const m = d.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); if(!m) return 0; return (parseInt(m[1])||0)*3600 + (parseInt(m[2])||0)*60 + (parseInt(m[3])||0); }
      
      function classifyVideo(video) {
        const t = titleAndDescription(video);
        const tags = (video.snippet?.tags || []).map(tag => tag.toLowerCase());
        const d = getDurationInSeconds(video.contentDetails?.duration);
        
        if (t.includes("#shorts") || t.includes(" shorts") || (d > 0 && d < 60)) return "shorts";
        if (video.snippet?.liveBroadcastContent === 'live' || t.includes("ðŸ”´")) return "live";
        if (tags.includes("ost") || tags.includes("soundtrack")) return "ost";
        if ((tags.includes("trailer") || t.includes("trailer")) && d < 300) return "trailer";
        if (tags.includes("speedrun") || t.includes("speedrun")) return "speedrun";
        if (tags.includes("walkthrough") || t.includes("longplay")) return "walkthrough";
        if (tags.includes("review") || t.includes("review")) return "review";
        if (tags.includes("remaster")) return "remaster";
        return "other";
      }

      function passesFilter(video) { return activeFilter === "all" ? classifyVideo(video) !== 'shorts' : classifyVideo(video) === activeFilter; }
      function formatViewCount(c) { if (!c) return "0"; const n = parseInt(c); return n >= 1000000 ? (n / 1000000).toFixed(1) + "M" : n >= 1000 ? (n / 1000).toFixed(1) + "K" : n.toString(); }
      function formatDate(s) { if(!s) return ""; const d = new Date(s), diff = Math.ceil(Math.abs(new Date() - d)/(1000*60*60*24)); return diff < 7 ? `${diff} days ago` : d.toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'}); }
      function parseDuration(d) { if (!d) return null; const m = d.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); if (!m) return null; const h=parseInt(m[1])||0, min=parseInt(m[2])||0, s=parseInt(m[3])||0; return h>0 ? `${h}:${String(min).padStart(2,'0')}:${String(s).padStart(2,'0')}` : `${min}:${String(s).padStart(2,'0')}`; }

      // LOGIC
      function updateHeroVideo() {
        const candidates = [...(dataStore.trending.week || []), ...(dataStore.mostViewed.allTime || [])];
        const trailer = candidates.find(v => classifyVideo(v) === 'trailer' || classifyVideo(v) === 'remaster') || candidates[0];
        
        if (trailer) {
            const videoId = typeof trailer.id === 'string' ? trailer.id : trailer.id?.videoId;
            // Inject background video
            heroVideoBg.innerHTML = `
                <iframe 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&loop=1&playlist=${videoId}&playsinline=1&start=10" 
                    frameborder="0" 
                    allow="autoplay; encrypted-media" 
                    allowfullscreen>
                </iframe>
                <div class="absolute inset-0 bg-[url('https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg')] bg-cover bg-center -z-10"></div>
            `;
        }
      }

      function processData(data) {
        dataStore = {
            mostViewed: data.mostViewed || { today: [], week: [], month: [], allTime: [] },
            trending: data.trending || { today: [], week: [] },
            newest: data.newest || [],
            live: data.live || [],
            updated: data.updated
        };
        [...dataStore.newest, ...dataStore.live].forEach(v => classifyVideo(v));
        
        buildFilters();
        renderAll(true);
        updateHeroVideo();
        
        if (data.updated) {
            const date = new Date(data.updated);
            document.getElementById("header-updated").innerHTML = `<i class="ph-fill ph-circle text-accent text-[8px] animate-pulse"></i> Updated ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        }
      }

      function buildFilters() {
        filtersEl.innerHTML = "";
        const tagSet = new Set(['all']);
        const all = [...(dataStore.mostViewed.today || []), ...(dataStore.mostViewed.week || []), ...(dataStore.mostViewed.allTime || []), ...dataStore.newest, ...dataStore.live];
        all.forEach(video => { const tag = classifyVideo(video); if (tag !== "other") tagSet.add(tag); });
        
        filterOrder.forEach(key => {
          if (!tagSet.has(key)) return;
          const meta = filterMeta[key];
          const btn = document.createElement("button");
          btn.className = "flex-shrink-0 px-6 py-2.5 rounded-full text-[11px] font-bold uppercase tracking-widest cursor-pointer flex items-center gap-2 transition-all duration-300 border border-white/10 bg-white/5 text-subtle hover:bg-white hover:text-black hover:border-white active:scale-95 data-[active=true]:bg-white data-[active=true]:text-black data-[active=true]:border-white";
          if (key === activeFilter) btn.setAttribute('data-active', 'true');
          btn.dataset.filter = key;
          btn.innerHTML = `<i class="ph-fill ${meta.icon} text-sm"></i>${meta.label}`;
          filtersEl.appendChild(btn);
        });
      }

      function renderRow(videos, container, sectionKey, isShortSection, isLiveSection = false) {
        container.innerHTML = "";
        
        let filtered = isShortSection ? videos : isLiveSection ? videos.filter(v => classifyVideo(v) === "live") : videos.filter(v => {
            const tag = classifyVideo(v);
            if (tag === "shorts" || tag === "live") return false;
            return passesFilter(v);
        });

        const sectionEl = sections[sectionKey === 'mostViewed' ? 'mostViewed' : sectionKey === 'newest' ? 'latest' : sectionKey];

        if (!filtered || filtered.length === 0) {
          if (activeFilter !== 'all' && sectionEl) sectionEl.classList.add('hidden');
          return;
        }
        
        if (sectionEl) sectionEl.classList.remove('hidden');
        
        const limit = loadMoreState[sectionKey];
        const videosToShow = filtered.slice(0, limit);
        
        videosToShow.forEach((video, index) => {
          const videoId = typeof video.id === 'string' ? video.id : video.id?.videoId;
          if (!videoId) return;
          
          const title = video.snippet?.title || "Untitled";
          const channel = video.snippet?.channelTitle || "Unknown";
          const date = formatDate(video.snippet?.publishedAt);
          const tag = classifyVideo(video);
          const isShort = isShortSection || tag === "shorts";
          const viewCount = formatViewCount(video.statistics?.viewCount);
          const duration = parseDuration(video.contentDetails?.duration);
          
          const cardBase = "group flex flex-col w-[280px] md:w-[320px] flex-shrink-0 cursor-pointer snap-start transition-all duration-500 hover:z-10";
          const shortWidth = "w-[160px] md:w-[190px]";
          const thumbAspect = isShort ? "aspect-[9/16]" : "aspect-video";
          
          const card = document.createElement("div");
          card.className = `${cardBase} ${isShort ? shortWidth : ''}`;
          card.onclick = () => openLightbox(index, filtered);
          
          card.innerHTML = `
            <div class="relative w-full ${thumbAspect} rounded-lg overflow-hidden bg-surface mb-3 shadow-lg border border-white/5 group-hover:scale-105 group-hover:shadow-[0_0_30px_rgba(0,0,0,0.6)] group-hover:border-white/20 transition-all duration-300">
                <img src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" loading="lazy" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />
                ${duration ? `<div class="absolute bottom-2 right-2 px-1.5 py-0.5 bg-black/80 backdrop-blur-md rounded text-[10px] font-bold text-white border border-white/10 tracking-wider">${duration}</div>` : ''}
                ${tag === 'live' ? `<div class="absolute top-2 left-2 px-2 py-0.5 bg-red text-white text-[10px] font-bold rounded uppercase tracking-wider animate-pulse">LIVE</div>` : ''}
                <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                    <div class="w-12 h-12 rounded-full bg-white text-black flex items-center justify-center shadow-2xl transform scale-50 group-hover:scale-100 transition-transform duration-300"><i class="ph-fill ph-play text-xl ml-1"></i></div>
                </div>
            </div>
            
            <div class="px-1 opacity-70 group-hover:opacity-100 transition-opacity">
                <h3 class="text-sm font-bold text-white leading-snug line-clamp-2 mb-1 group-hover:text-white transition-colors">${title}</h3>
                <div class="flex flex-wrap items-center gap-x-2 gap-y-1 text-[11px] text-subtle font-medium">
                    <span class="hover:text-white transition-colors">${channel}</span>
                    <span>â€¢</span>
                    <span>${viewCount}</span>
                    <span>â€¢</span>
                    <span>${date}</span>
                </div>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function renderAll(reset = false) {
        if (reset) loadMoreState = { mostViewed: 10, trending: 10, live: 10, newest: 10, shorts: 20 };
        
        let rawMostViewed = dataStore.mostViewed[sortState.mostViewed] || [];
        if (sortState.mostViewed === 'allTime') {
            const combined = [...rawMostViewed, ...dataStore.newest];
            const seen = new Set();
            rawMostViewed = combined.filter(v => {
                const id = typeof v.id === 'string' ? v.id : v.id?.videoId;
                if (!id || seen.has(id)) return false;
                seen.add(id);
                return true;
            }).sort((a, b) => (parseInt(b.statistics?.viewCount || 0) - parseInt(a.statistics?.viewCount || 0)));
        }
        
        let shortsOnly = [...dataStore.mostViewed.allTime, ...dataStore.newest].filter(v => classifyVideo(v) === "shorts");
        if (sortState.shorts === 'popular') {
            shortsOnly.sort((a, b) => (parseInt(b.statistics?.viewCount || 0) - parseInt(a.statistics?.viewCount || 0)));
        } else {
            shortsOnly.sort((a, b) => new Date(b.snippet?.publishedAt || 0) - new Date(a.snippet?.publishedAt || 0));
        }

        renderRow(rawMostViewed, containers.mostViewed, 'mostViewed', false);
        renderRow(dataStore.trending[sortState.trending] || [], containers.trending, 'trending', false);
        renderRow(dataStore.live, containers.live, 'live', false, true);
        renderRow(dataStore.newest, containers.latest, 'newest', false);
        renderRow(shortsOnly, containers.shorts, 'shorts', true);
      }

      // --- INFINITE SCROLL ---
      function handleInfiniteScroll(container, sectionKey) {
          if (container.scrollLeft + container.clientWidth >= container.scrollWidth - 300) {
              if(!container.dataset.loading) {
                  container.dataset.loading = "true";
                  loadMoreState[sectionKey] += 10;
                  renderAll(); 
                  setTimeout(() => { container.dataset.loading = ""; }, 500);
              }
          }
      }

      Object.keys(containers).forEach(key => {
          const container = containers[key];
          const sectionKey = key === 'latest' ? 'newest' : (key === 'mostViewed' ? 'mostViewed' : key);
          container.addEventListener('scroll', () => handleInfiniteScroll(container, sectionKey));
      });

      // --- EVENTS ---
      filtersEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        activeFilter = btn.dataset.filter;
        [...filtersEl.children].forEach(b => b.removeAttribute('data-active'));
        btn.setAttribute('data-active', 'true');
        renderAll(true);
      });

      ['most-viewed', 'trending', 'shorts'].forEach(key => {
          const el = document.getElementById(`${key}-sort`);
          if(el) el.addEventListener('click', (e) => {
              const btn = e.target.closest('button');
              if(!btn) return;
              const type = btn.dataset.timeframe || btn.dataset.sort;
              sortState[key === 'most-viewed' ? 'mostViewed' : key === 'shorts' ? 'shorts' : 'trending'] = type;
              [...el.children].forEach(b => b.removeAttribute('data-active'));
              btn.setAttribute('data-active', 'true');
              renderAll();
          });
      });

      // --- SHEET ---
      function openLightbox(index, list) {
        history.pushState({modalOpen: true}, "Video", "#video");
        currentLightboxList = list;
        currentLightboxIndex = index;
        document.body.classList.add('overflow-hidden');
        updateSheet();
        videoSheet.classList.remove('translate-y-full');
        sheetBackdrop.classList.remove('opacity-0');
      }

      function closeSheet() {
        videoSheet.classList.add('translate-y-full');
        sheetBackdrop.classList.add('opacity-0');
        document.body.classList.remove('overflow-hidden');
        if (history.state?.modalOpen) history.back();
        setTimeout(() => { videoEmbedContainer.innerHTML = ""; }, 500);
      }

      function updateSheet() {
        const video = currentLightboxList[currentLightboxIndex];
        if(!video) return;
        const videoId = typeof video.id === 'string' ? video.id : video.id?.videoId;
        const isShort = classifyVideo(video) === 'shorts';
        
        videoEmbedContainer.innerHTML = `
            <iframe class="w-full h-full border-none ${isShort ? 'aspect-[9/16] max-w-[400px] mx-auto' : ''}" 
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&rel=0&playsinline=1" 
                allowfullscreen allow="autoplay; encrypted-media; picture-in-picture">
            </iframe>
        `;

        const title = video.snippet?.title;
        const desc = video.snippet?.description;
        const channel = video.snippet?.channelTitle;
        const views = formatViewCount(video.statistics?.viewCount);
        
        sheetDetails.innerHTML = `
            <div class="max-w-2xl">
                <h1 class="text-xl md:text-3xl font-bold text-white mb-4 leading-tight">${title}</h1>
                <div class="flex items-center gap-4 mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white font-bold text-lg border border-white/5">${channel.charAt(0)}</div>
                        <div>
                            <div class="text-white font-bold text-sm">${channel}</div>
                            <div class="text-subtle text-xs">${views} views</div>
                        </div>
                    </div>
                    <a href="https://youtube.com/watch?v=${videoId}" target="_blank" class="ml-auto bg-white hover:bg-gray-200 text-black px-6 py-2 rounded font-bold text-xs uppercase tracking-widest transition-colors shadow-lg">Watch on YT</a>
                </div>
                <div class="prose prose-invert prose-sm text-subtle leading-relaxed whitespace-pre-wrap">${desc}</div>
            </div>
        `;

        sheetPrev.disabled = currentLightboxIndex === 0;
        sheetNext.disabled = currentLightboxIndex >= currentLightboxList.length - 1;
      }

      sheetPrev.onclick = () => { if(currentLightboxIndex > 0) { currentLightboxIndex--; updateSheet(); }};
      sheetNext.onclick = () => { if(currentLightboxIndex < currentLightboxList.length - 1) { currentLightboxIndex++; updateSheet(); }};
      window.onpopstate = () => videoSheet.classList.contains('translate-y-full') || closeSheet();

      // --- INIT ---
      async function init() {
        const CACHE_KEY = 'tuberaider_data';
        const cached = localStorage.getItem(CACHE_KEY);
        let data;
        if (cached && (new Date().getTime() - JSON.parse(cached).timestamp < 1000 * 60 * 30)) {
            data = JSON.parse(cached).data;
        } else {
            try {
                const res = await fetch("https://tuberaider.tombraiderarchives.workers.dev/videos");
                data = await res.json();
                localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: new Date().getTime(), data }));
            } catch(e) { console.error(e); }
        }
        if(data) processData(data);
      }
      
      init();
    </script>
  </body>
</html>