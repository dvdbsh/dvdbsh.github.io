<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TubeRaider</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <style>
      :root {
        --bg-dark: #05070a;
        --bg-card: #131824;
        --bg-hover: #1a2235;
        --accent: #26b58b;
        --accent-light: #2ecfa1;
        --text-primary: #ffffff;
        --text-secondary: #b0b9cc;
        --text-tertiary: #7a8299;
        --border: #1f2937;
        --gold: #f0c76a;
        --live-red: #ff4444; /* Brighter red for live */
        --live-bg: rgba(255, 68, 68, 0.15);
        --background-image: url("scene.webp");
        font-family: "Outfit", system-ui, -apple-system, sans-serif;
        font-size: 18px;
      }

      * {
        box-sizing: border-box;
        scrollbar-width: thin;
        scrollbar-color: #3b4554 #0a0e17;
      }

      *::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      *::-webkit-scrollbar-track {
        background: #0a0e17;
      }

      *::-webkit-scrollbar-thumb {
        background: #3b4554;
        border-radius: 4px;
      }

      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(180deg, var(--bg-dark) 0%, #0f1420 100%);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        position: relative;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 1000px;
        height: 543px;
        background-image: var(--background-image);
        background-repeat: no-repeat;
        background-size: contain;
        opacity: 0.5;
        pointer-events: none;
        z-index: -1;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      /* HEADER */
      .header {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: rgba(5, 7, 10, 0.9);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(31, 41, 55, 0.5);
        padding: 20px 0;
      }

      .header-inner {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 40px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .brand-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
        color: #020308;
        box-shadow: 0 0 15px rgba(46, 207, 161, 0.3);
      }

      .brand-name {
        font-weight: 700;
        font-size: 1.5rem;
        letter-spacing: 0.15em;
        background: linear-gradient(135deg, var(--accent-light), var(--gold));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-info {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .info-pill {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        background: rgba(38, 181, 139, 0.05);
        border: 1px solid rgba(38, 181, 139, 0.2);
        border-radius: 20px;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .info-pill i {
        font-size: 0.95rem;
        color: var(--accent);
      }

      /* MAIN */
      main {
        max-width: 1400px;
        margin: 0 auto;
        padding: 50px 40px;
      }

      .hero-section {
        margin-bottom: 60px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .hero-text h1 {
        font-size: 3rem;
        font-weight: 800;
        margin: 0 0 12px;
        line-height: 1.1;
        color: var(--text-primary);
      }

      .hero-text p {
        font-size: 1.2rem;
        color: var(--text-secondary);
        margin: 0;
        max-width: 500px;
      }

      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 24px;
      }

      .filter-pill {
        padding: 10px 16px;
        border: 1px solid var(--border);
        border-radius: 24px;
        background: var(--bg-card);
        color: var(--text-secondary);
        font-size: 0.7rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .filter-pill:hover {
        background: var(--bg-hover);
        border-color: var(--accent);
        color: var(--text-primary);
      }

      .filter-pill.active {
        background: var(--accent);
        border-color: var(--accent);
        color: #020308;
        box-shadow: 0 0 15px rgba(38, 181, 139, 0.4);
      }

      .filter-pill i {
        font-size: 0.95rem;
      }

      .filter-pill.active i {
        color: #020308;
      }

      /* SECTIONS */
      .section {
        margin-bottom: 80px;
      }

      .section-header {
        margin-bottom: 20px;
        padding-left: 4px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 16px;
      }

      .section-header-text {
        flex: 1;
        min-width: 200px;
      }

      .section-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 8px;
        letter-spacing: -0.02em;
      }

      .section-subtitle {
        font-size: 0.95rem;
        color: var(--text-tertiary);
        margin: 0;
      }

      .section-sort-pills {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .sort-pill {
        padding: 6px 12px;
        border: 1px solid var(--border);
        border-radius: 16px;
        background: var(--bg-card);
        color: var(--text-secondary);
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .sort-pill:hover {
        background: var(--bg-hover);
        border-color: var(--accent);
        color: var(--text-primary);
      }

      .sort-pill.active {
        background: var(--accent);
        border-color: var(--accent);
        color: #020308;
        box-shadow: 0 0 10px rgba(38, 181, 139, 0.3);
      }

      .video-row-shell {
        position: relative;
        display: block;
      }
      
      /* MAIN VIDEO GRID */
      .video-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr); /* 5 videos per row */
        gap: 24px;
        padding: 24px 4px;
      }

      /* SHORTS SCROLLER - HORIZONTAL MODE */
      .video-row.shorts-row {
        display: flex;
        overflow-x: auto;
        gap: 16px;
        grid-template-columns: none;
        scroll-behavior: smooth;
        -ms-overflow-style: none;
        scrollbar-width: none;
        padding-bottom: 10px;
        scroll-snap-type: x mandatory; /* Snap for clean scrolling */
      }
      
      .video-row.shorts-row::-webkit-scrollbar {
        display: none;
      }
      
      /* STRICT 7 ITEMS LOGIC: (100% - (6 gaps * 16px)) / 7 items */
      /* 6 * 16 = 96px */
      .video-row.shorts-row .video-card {
        min-width: calc((100% - 96px) / 7); 
        width: calc((100% - 96px) / 7);
        flex-shrink: 0;
        scroll-snap-align: start; /* Snap each card to start */
      }

      /* Navigation Arrows */
      .arrow-btn {
        display: none;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        background: rgba(19, 24, 36, 0.95);
        border: 1px solid var(--border);
        color: var(--accent);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(0,0,0,0.8);
      }
      
      /* Only show arrows for shorts */
      #shorts-prev, #shorts-next {
          display: flex;
          opacity: 0;
          pointer-events: none;
      }

      .video-row-shell:hover #shorts-prev, 
      .video-row-shell:hover #shorts-next {
          opacity: 1;
          pointer-events: auto;
      }

      .arrow-btn:hover {
        background: var(--accent);
        color: #000;
        transform: translateY(-50%) scale(1.1);
      }
      
      .arrow-btn i {
          font-size: 1.5rem;
      }

      #shorts-prev { left: -24px; }
      #shorts-next { right: -24px; }

      /* VIDEO CARDS */
      .video-card {
        width: 100%;
        background: var(--bg-card);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(31, 41, 55, 0.5);
        transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        position: relative;
        height: 100%; /* Uniform height */
      }

      .video-card:hover {
        border-color: var(--accent);
        box-shadow: 0 0 25px rgba(38, 181, 139, 0.15);
        z-index: 2;
        transform: translateY(-4px);
      }

      /* LIVE CARD OVERRIDE */
      .video-card.live-card {
        border-color: rgba(255, 68, 68, 0.3);
      }
      
      .video-card.live-card:hover {
        border-color: var(--live-red);
        box-shadow: 0 0 25px rgba(255, 68, 68, 0.2);
      }

      .video-thumb {
        position: relative;
        width: 100%;
        background: #0f1420;
        overflow: hidden;
      }

      .video-thumb.ratio-16x9 {
        aspect-ratio: 16 / 9;
      }

      /* Make shorts ratio stricter so they aren't "huge" vertically */
      .video-thumb.ratio-shorts {
        aspect-ratio: 9 / 16; 
      }
      
      .duration-badge {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .stats-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .stats-badge i {
        font-size: 0.85rem;
      }

      .video-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.5s ease;
        opacity: 0.9;
      }

      .video-card:hover .video-thumb img {
        opacity: 1;
      }

      .overlay-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(38, 181, 139, 0.9);
        color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }
      
      /* Live overlay icon override */
      .video-card.live-card .overlay-icon {
          background: rgba(255, 68, 68, 0.9);
      }

      .video-card:hover .overlay-icon {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }

      .video-info {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
        justify-content: space-between; /* Push bottom content down */
      }

      .video-text-group {
          display: flex;
          flex-direction: column;
          gap: 6px;
      }

      .video-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-primary);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
      }

      .video-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        font-size: 0.75rem;
        color: var(--text-tertiary);
        align-items: center;
      }
      
      .video-footer {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-top: 8px;
      }

      /* NEW TAG STYLE: Pill shape, aligned left */
      .video-tag {
        display: inline-flex;
        padding: 4px 10px;
        background: rgba(38, 181, 139, 0.1);
        border: 1px solid rgba(38, 181, 139, 0.2);
        border-radius: 12px; /* Pill shape */
        color: var(--accent);
        font-weight: 600;
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        white-space: nowrap;
      }

      .video-tag.short-tag {
        background: rgba(240, 199, 106, 0.1);
        border-color: rgba(240, 199, 106, 0.2);
        color: var(--gold);
      }

      .video-tag.live-tag {
        background: var(--live-bg);
        border-color: rgba(255, 68, 68, 0.3);
        color: var(--live-red);
      }

      .status-msg {
        font-size: 0.9rem;
        color: var(--text-tertiary);
        margin-top: 12px;
        padding: 0 0 0 12px;
      }

      .status-msg.error {
        color: #ff6b6b;
      }

      /* LIGHTBOX */
      .lightbox {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(8px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        padding: 40px;
      }

      .lightbox.active {
        opacity: 1;
        pointer-events: auto;
      }

      .lightbox-content {
        position: relative;
        width: 100%;
        max-width: 1100px;
        aspect-ratio: 16 / 9;
        background: #000;
        border-radius: 16px;
        box-shadow: 0 0 50px rgba(38, 181, 139, 0.1);
        border: 1px solid rgba(38, 181, 139, 0.2);
      }

      .lightbox-content.short-mode {
        max-width: 500px;
        aspect-ratio: 9 / 16;
      }

      .lightbox-close {
        position: absolute;
        top: -50px;
        right: 0;
        background: none;
        border: none;
        color: #fff;
        font-size: 2.5rem;
        cursor: pointer;
        transition: color 0.2s;
      }

      .lightbox-close:hover {
        color: var(--accent);
      }

      .lightbox-iframe {
        width: 100%;
        height: 100%;
        border-radius: 16px;
        border: none;
      }

      /* SKELETONS */
      .skeleton {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        width: 100%;
        aspect-ratio: 16/12;
        position: relative;
        overflow: hidden;
      }

      .skeleton::after {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
        animation: shimmer 1.5s infinite;
        transform: translateX(-100%);
      }

      .skeleton.short {
        aspect-ratio: 9/16;
        min-width: calc((100% - 96px) / 7); 
      }

      @keyframes shimmer {
        100% {
          transform: translateX(100%);
        }
      }

      /* LOAD MORE BUTTON */
      .load-more-btn {
        display: block;
        width: 100%;
        max-width: 300px;
        margin: 24px auto 0;
        padding: 14px 28px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 24px;
        color: var(--text-secondary);
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .load-more-btn:hover {
        background: var(--accent);
        border-color: var(--accent);
        color: #020308;
        box-shadow: 0 0 15px rgba(38, 181, 139, 0.4);
      }

      .load-more-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .load-more-btn.hidden {
        display: none;
      }

      /* FOOTER */
      footer {
        border-top: 1px solid var(--border);
        padding: 40px 0;
        text-align: center;
        color: var(--text-tertiary);
        font-size: 0.9rem;
        margin-top: 80px;
        background: var(--bg-dark);
      }

      /* RESPONSIVE */
      @media (max-width: 1280px) {
        .video-row {
            grid-template-columns: repeat(4, 1fr);
        }
        /* Fallback for smaller desktops: Show 5 shorts */
        /* (100% - 4*16) / 5 */
        .video-row.shorts-row .video-card {
            min-width: calc((100% - 64px) / 5); 
            width: calc((100% - 64px) / 5); 
        }
      }
      
      @media (max-width: 1024px) {
        main {
          padding: 40px 24px;
        }

        .header-inner {
          padding: 0 24px;
        }

        .hero-section {
          flex-direction: column;
        }

        .hero-text h1 {
          font-size: 2.8rem;
        }

        .section-title {
          font-size: 2.2rem;
        }

        .lightbox {
          padding: 20px;
        }

        .lightbox-close {
          top: -40px;
          right: 10px;
        }

        /* Tablet: 3 columns for regular videos */
        .video-row {
          grid-template-columns: repeat(3, 1fr);
        }

        /* Tablet: Shorts 4 items */
        .video-row.shorts-row .video-card {
             min-width: calc(25% - 12px);
             width: calc(25% - 12px);
        }
      }

      @media (max-width: 768px) {
          .video-row {
             grid-template-columns: repeat(2, 1fr);
          }
          .video-row.shorts-row .video-card {
             min-width: calc(33.33% - 11px);
             width: calc(33.33% - 11px);
        }
      }

      @media (max-width: 640px) {
        main {
          padding: 28px 16px;
        }

        .header-inner {
          padding: 0 16px;
        }

        .hero-text h1 {
          font-size: 2.2rem;
        }

        .hero-text p {
          font-size: 0.95rem;
        }

        .section-title {
          font-size: 1.2rem;
        }

        /* Mobile: Single column like YouTube mobile */
        .video-row {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        /* Mobile: Shorts ~2 items */
        .video-row.shorts-row .video-card {
            min-width: calc(45% - 8px); 
            width: calc(45% - 8px); 
        }
        
        #shorts-prev, #shorts-next {
            display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <div class="brand">
          <div class="brand-icon">TR</div>
          <div class="brand-name">TUBERAIDER</div>
        </div>
        <div class="header-info">
          <div class="info-pill">
            <i class="ph ph-compass"></i> Tomb Raider only
          </div>
          <div class="info-pill" id="header-updated">
            <i class="ph ph-clock"></i> Just now
          </div>
        </div>
      </div>
    </header>
    <main>
      <div class="hero-section">
        <div class="hero-text">
          <h1>TubeRaider</h1>
          <p>Discover the latest walkthroughs, trailers, speedruns, and content from the Tomb Raider universe.</p>
          <div class="filters" id="filters"></div>
        </div>
      </div>
      <section class="section">
        <div class="section-header">
          <div class="section-header-text">
            <h2 class="section-title">Most Viewed</h2>
            <p class="section-subtitle">Biggest results from the search</p>
          </div>
          <div class="section-sort-pills" id="most-viewed-sort">
            <button class="sort-pill active" data-timeframe="allTime">All Time</button>
            <button class="sort-pill" data-timeframe="month">This Month</button>
            <button class="sort-pill" data-timeframe="week">This Week</button>
            <button class="sort-pill" data-timeframe="today">Today</button>
          </div>
        </div>
        <div class="video-row-shell">
          <button class="arrow-btn" id="most-viewed-prev">
            <i class="ph ph-caret-left"></i>
          </button>
          <div class="video-row" id="most-viewed-container"></div>
          <button class="arrow-btn" id="most-viewed-next">
            <i class="ph ph-caret-right"></i>
          </button>
        </div>
        <button class="load-more-btn hidden" id="most-viewed-load-more">
          <i class="ph ph-arrows-clockwise"></i> Load More </button>
        <div class="status-msg" id="most-viewed-status"></div>
      </section>
      <section class="section">
        <div class="section-header">
          <div class="section-header-text">
            <h2 class="section-title">Trending</h2>
            <p class="section-subtitle">What's popular right now</p>
          </div>
          <div class="section-sort-pills" id="trending-sort">
            <button class="sort-pill active" data-timeframe="week">This Week</button>
            <button class="sort-pill" data-timeframe="today">Today</button>
          </div>
        </div>
        <div class="video-row-shell">
          <button class="arrow-btn" id="trending-prev">
            <i class="ph ph-caret-left"></i>
          </button>
          <div class="video-row" id="trending-container"></div>
          <button class="arrow-btn" id="trending-next">
            <i class="ph ph-caret-right"></i>
          </button>
        </div>
        <button class="load-more-btn hidden" id="trending-load-more">
          <i class="ph ph-arrows-clockwise"></i> Load More </button>
        <div class="status-msg" id="trending-status"></div>
      </section>
      <section class="section">
        <div class="section-header">
          <div class="section-header-text">
            <h2 class="section-title">Live Now</h2>
            <p class="section-subtitle">Ongoing streams and premieres</p>
          </div>
        </div>
        <div class="video-row-shell">
          <button class="arrow-btn" id="live-prev">
            <i class="ph ph-caret-left"></i>
          </button>
          <div class="video-row" id="live-container"></div>
          <button class="arrow-btn" id="live-next">
            <i class="ph ph-caret-right"></i>
          </button>
        </div>
        <button class="load-more-btn hidden" id="live-load-more">
          <i class="ph ph-arrows-clockwise"></i> Load More </button>
        <div class="status-msg" id="live-status"></div>
      </section>
      <section class="section">
        <div class="section-header">
          <div class="section-header-text">
            <h2 class="section-title">Latest</h2>
            <p class="section-subtitle">Fresh uploads</p>
          </div>
        </div>
        <div class="video-row-shell">
          <button class="arrow-btn" id="new-prev">
            <i class="ph ph-caret-left"></i>
          </button>
          <div class="video-row" id="new-container"></div>
          <button class="arrow-btn" id="new-next">
            <i class="ph ph-caret-right"></i>
          </button>
        </div>
        <button class="load-more-btn hidden" id="new-load-more">
          <i class="ph ph-arrows-clockwise"></i> Load More </button>
        <div class="status-msg" id="new-status"></div>
      </section>
      <section class="section">
        <div class="section-header">
          <div class="section-header-text">
            <h2 class="section-title">Shorts</h2>
            <p class="section-subtitle">Quick clips</p>
          </div>
          <!-- New Sort Toggle for Shorts -->
          <div class="section-sort-pills" id="shorts-sort">
            <button class="sort-pill active" data-sort="latest">Latest</button>
            <button class="sort-pill" data-sort="popular">Popular</button>
          </div>
        </div>
        <div class="video-row-shell">
          <button class="arrow-btn" id="shorts-prev">
            <i class="ph ph-caret-left"></i>
          </button>
          <div class="video-row shorts-row" id="shorts-container"></div>
          <button class="arrow-btn" id="shorts-next">
            <i class="ph ph-caret-right"></i>
          </button>
        </div>
        <div class="status-msg" id="shorts-status"></div>
      </section>
    </main>
    <footer>
      <p>Â© 2025 TubeRaider â€” Curated Tomb Raider content</p>
    </footer>
    <!-- LIGHTBOX -->
    <div id="lightbox" class="lightbox">
      <button class="lightbox-close" id="lightbox-close">
        <i class="ph ph-x"></i>
      </button>
      <div class="lightbox-content" id="lightbox-content">
        <!-- Iframe injected here -->
      </div>
    </div>
    <script>
      const MOST_VIEWED_CONTAINER = document.getElementById("most-viewed-container");
      const TRENDING_CONTAINER = document.getElementById("trending-container");
      const LIVE_CONTAINER = document.getElementById("live-container");
      const NEW_CONTAINER = document.getElementById("new-container");
      const SHORTS_CONTAINER = document.getElementById("shorts-container");
      const MOST_VIEWED_STATUS = document.getElementById("most-viewed-status");
      const TRENDING_STATUS = document.getElementById("trending-status");
      const LIVE_STATUS = document.getElementById("live-status");
      const NEW_STATUS = document.getElementById("new-status");
      const SHORTS_STATUS = document.getElementById("shorts-status");
      const MOST_VIEWED_LOAD_MORE = document.getElementById("most-viewed-load-more");
      const TRENDING_LOAD_MORE = document.getElementById("trending-load-more");
      const LIVE_LOAD_MORE = document.getElementById("live-load-more");
      const NEW_LOAD_MORE = document.getElementById("new-load-more");
      const filtersEl = document.getElementById("filters");
      const headerUpdated = document.getElementById("header-updated");
      // Lightbox Elements
      const lightbox = document.getElementById("lightbox");
      const lightboxContent = document.getElementById("lightbox-content");
      const lightboxClose = document.getElementById("lightbox-close");
      let dataStore = {
        mostViewed: {
          today: [],
          week: [],
          month: [],
          allTime: []
        },
        trending: {
          today: [],
          week: []
        },
        newest: [],
        live: [],
        updated: null
      };
      // State for active sort options
      let sortState = {
        mostViewed: 'allTime',
        trending: 'week',
        shorts: 'latest' // Added sort state for shorts
      };
      // State for Load More functionality - tracks how many videos to show per section
      let loadMoreState = {
        mostViewed: 10,
        trending: 10,
        live: 10,
        newest: 10,
        shorts: 20
      };
      let activeFilter = "all";
      // Added "review" to the filter order
      const filterOrder = ["all", "live", "walkthrough", "review", "ost", "trailer", "remaster", "speedrun"];
      const filterMeta = {
        all: {
          label: "All",
          icon: "ph-sparkle"
        },
        live: {
          label: "Live",
          icon: "ph-broadcast"
        },
        walkthrough: {
          label: "Walkthroughs",
          icon: "ph-game-controller"
        },
        // New Review Filter
        review: {
          label: "Reviews",
          icon: "ph-star"
        },
        ost: {
          label: "Soundtracks",
          icon: "ph-music-note"
        },
        trailer: {
          label: "Trailers",
          icon: "ph-film-strip"
        },
        remaster: {
          label: "Remasters",
          icon: "ph-magic-wand"
        },
        speedrun: {
          label: "Speedruns",
          icon: "ph-lightning"
        }
      };

      function showSkeletons() {
        // Create grid of skeletons
        [MOST_VIEWED_CONTAINER, TRENDING_CONTAINER, LIVE_CONTAINER, NEW_CONTAINER].forEach((container) => {
          container.innerHTML = "";
          for (let i = 0; i < 10; i++) { // 10 skeletons for 5 cols x 2 rows
            const sk = document.createElement("div");
            sk.className = "skeleton";
            container.appendChild(sk);
          }
        });
        // Shorts skeletons
        SHORTS_CONTAINER.innerHTML = "";
        for (let i = 0; i < 8; i++) {
          const sk = document.createElement("div");
          sk.className = "skeleton short";
          SHORTS_CONTAINER.appendChild(sk);
        }
        MOST_VIEWED_STATUS.textContent = "";
        TRENDING_STATUS.textContent = "";
        LIVE_STATUS.textContent = "";
        NEW_STATUS.textContent = "";
        SHORTS_STATUS.textContent = "";
      }

      function titleAndDescription(video) {
        const title = (video.snippet && video.snippet.title) || "";
        const description = (video.snippet && video.snippet.description) || "";
        return (title + " " + description).toLowerCase();
      }

      function classifyVideo(video, checkAspectRatio = false) {
        const t = titleAndDescription(video);
        
        // Helper for whole word matching
        const hasWord = (word) => new RegExp(`\\b${word}\\b`, 'i').test(t);
        const hasPhrase = (phrase) => t.includes(phrase); 
        
        // 1. Explicit Shorts markers
        if (t.includes("#shorts") || t.includes(" shorts") || t.includes("ytshorts")) {
          return "shorts";
        }

        // 2. Aspect Ratio Check
        if (checkAspectRatio) {
          const videoId = typeof video.id === 'string' ? video.id : (video.id && video.id.videoId ? video.id.videoId : null);
          if (videoId) {
            const img = new Image();
            img.src = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
            img.onload = function() {
              const ratio = this.width / this.height;
              if (ratio < 1) {
                video._isShort = true;
              }
            };
          }
        }
        if (video._isShort) {
          return "shorts";
        }

        // 3. STRICT DURATION RULE (The "2 Minute" Filter)
        // If a video is under 2 minutes (120 seconds), we classify it as a Short.
        // We do this BEFORE other checks so short trailers/clips don't clutter the main feeds.
        const duration = getDurationInSeconds(video.contentDetails && video.contentDetails.duration);
        if (duration > 0 && duration < 120) {
            return "shorts";
        }

        // Live Check
        if (video.snippet && (video.snippet.liveBroadcastContent === 'live' || video.snippet.liveBroadcastContent === 'upcoming')) {
          return "live";
        }
        if (t.includes("ðŸ”´") || t.includes("live now") || t.includes("[live]") || t.includes("streaming now")) {
          return "live";
        }

        // Review Check
        if (hasWord("review") || hasWord("retrospective") || hasWord("critique") || hasPhrase("video essay") || hasWord("analysis")) {
          return "review";
        }

        // Walkthrough
        if (hasWord("walkthrough") || hasWord("longplay") || hasPhrase("let's play") || hasPhrase("lets play") || hasWord("playthrough")) {
          return "walkthrough";
        }

        // Soundtrack
        if (hasWord("ost") || hasWord("soundtrack") || hasPhrase("theme song") || hasPhrase("official score") || hasPhrase("original score")) {
          return "ost";
        }
        
        // Trailer
        if (hasWord("trailer") || hasWord("teaser")) {
          return "trailer";
        }

        // Remaster
        if (hasWord("remaster") || hasWord("remastered")) {
          return "remaster";
        }

        // Speedrun
        if (hasWord("speedrun") || hasPhrase("speed run")) {
          return "speedrun";
        }

        return "other";
      }

      function passesFilter(video, isShortSection) {
        const tag = classifyVideo(video);
        if (isShortSection) {
          return tag === "shorts";
        }
        if (tag === "shorts") return false;
        if (activeFilter === "all") return true;
        return tag === activeFilter;
      }

      function buildFilters() {
        filtersEl.innerHTML = "";
        const tagSet = new Set();
        const all = [...(dataStore.mostViewed.today || []), ...(dataStore.mostViewed.week || []), ...(dataStore.mostViewed.month || []), ...(dataStore.mostViewed.allTime || []), ...(dataStore.trending.today || []), ...(dataStore.trending.week || []), ...dataStore.newest, ...dataStore.live];
        all.forEach((video) => {
          const tag = classifyVideo(video);
          if (tag !== "other") {
            tagSet.add(tag);
          }
        });
        filterOrder.forEach((key) => {
          if (key !== "all" && !tagSet.has(key)) return;
          const meta = filterMeta[key];
          if (!meta) return;
          const btn = document.createElement("button");
          btn.className = "filter-pill";
          if (key === activeFilter) btn.classList.add("active");
          btn.dataset.filter = key;
          btn.innerHTML = `
			<i class="ph ${meta.icon}"></i>${meta.label}`;
          filtersEl.appendChild(btn);
        });
      }
      filtersEl.addEventListener("click", (event) => {
        const btn = event.target.closest(".filter-pill");
        if (!btn) return;
        activeFilter = btn.dataset.filter || "all";
        [...filtersEl.querySelectorAll(".filter-pill")].forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        renderAll(true); // Reset load more state when filter changes
      });
      async function fetchVideos() {
        showSkeletons();
        try {
          const response = await fetch("https://tuberaider.tombraiderarchives.workers.dev/videos");
          if (!response.ok) throw new Error("Worker responded with " + response.status);
          const data = await response.json();
          dataStore.mostViewed = data.mostViewed || {
            today: [],
            week: [],
            month: [],
            allTime: []
          };
          dataStore.trending = data.trending || {
            today: [],
            week: []
          };
          dataStore.newest = data.newest || [];
          dataStore.live = data.live || [];
          dataStore.updated = data.updated || null;
          // Collect all videos for classification
          const allVideos = [...(dataStore.mostViewed.today || []), ...(dataStore.mostViewed.week || []), ...(dataStore.mostViewed.month || []), ...(dataStore.mostViewed.allTime || []), ...(dataStore.trending.today || []), ...(dataStore.trending.week || []), ...dataStore.newest, ...dataStore.live];
          allVideos.forEach((video) => {
            classifyVideo(video, true);
          });
          buildFilters();
          renderAll(true); // Reset load more state on initial load
          if (data.updated) {
            const d = new Date(data.updated);
            headerUpdated.innerHTML = `
			<i class="ph ph-clock"></i>${d.toLocaleTimeString()}`;
          }
        } catch (error) {
          console.error("Error loading videos", error);
          MOST_VIEWED_STATUS.classList.add("error");
          MOST_VIEWED_STATUS.textContent = "Could not load videos";
          TRENDING_STATUS.classList.add("error");
          TRENDING_STATUS.textContent = "Could not load videos";
          LIVE_STATUS.classList.add("error");
          LIVE_STATUS.textContent = "Could not load videos";
          NEW_STATUS.classList.add("error");
          NEW_STATUS.textContent = "Could not load videos";
          SHORTS_STATUS.classList.add("error");
          SHORTS_STATUS.textContent = "Could not load videos";
        }
      }

      function renderAll(resetLoadMore = false) {
        // Only reset load more state when filter changes, not on every render
        if (resetLoadMore) {
          loadMoreState = {
            mostViewed: 10,
            trending: 10,
            live: 10,
            newest: 10,
            shorts: 20
          };
        }
        // Get the active timeframe videos
        const mostViewedVideos = dataStore.mostViewed[sortState.mostViewed] || [];
        const trendingVideos = dataStore.trending[sortState.trending] || [];
        // Collect all videos from all timeframes for classification purposes
        const allVideos = [...(dataStore.mostViewed.today || []), ...(dataStore.mostViewed.week || []), ...(dataStore.mostViewed.month || []), ...(dataStore.mostViewed.allTime || []), ...(dataStore.trending.today || []), ...(dataStore.trending.week || []), ...dataStore.newest, ...dataStore.live];
        // Collect ALL live videos from all sources by classification
        const liveOnly = allVideos.filter(v => classifyVideo(v) === "live");
        
        // Collect shorts from all sources
        let shortsOnly = allVideos.filter(v => classifyVideo(v) === "shorts");
        
        // Sort Shorts based on toggle state
        if (sortState.shorts === 'popular') {
            shortsOnly.sort((a, b) => {
                const viewA = parseInt(a.statistics?.viewCount || 0);
                const viewB = parseInt(b.statistics?.viewCount || 0);
                return viewB - viewA; // Descending views
            });
        } else {
            // Default: Latest (sort by publish date descending)
            shortsOnly.sort((a, b) => {
                return new Date(b.snippet?.publishedAt || 0) - new Date(a.snippet?.publishedAt || 0);
            });
        }

        // For regular sections, use the selected timeframe data directly
        // These already filter out shorts and live in the renderRow function via passesFilter
        renderRow(mostViewedVideos, MOST_VIEWED_CONTAINER, MOST_VIEWED_STATUS, MOST_VIEWED_LOAD_MORE, 'mostViewed', false, false);
        renderRow(trendingVideos, TRENDING_CONTAINER, TRENDING_STATUS, TRENDING_LOAD_MORE, 'trending', false, false);
        renderRow(liveOnly, LIVE_CONTAINER, LIVE_STATUS, LIVE_LOAD_MORE, 'live', false, true);
        renderRow(dataStore.newest, NEW_CONTAINER, NEW_STATUS, NEW_LOAD_MORE, 'newest', false, false);
        // Pass null for loadMoreBtn to indicate shorts section
        renderRow(shortsOnly, SHORTS_CONTAINER, SHORTS_STATUS, null, 'shorts', true, false);
      }


      // ===== HELPER FUNCTIONS FOR STATISTICS =====
      
      // Format view count (e.g., 1234567 -> "1.2M")
      function formatViewCount(count) {
        if (!count) return "0";
        const num = parseInt(count);
        if (num >= 1000000) {
          return (num / 1000000).toFixed(1) + "M";
        } else if (num >= 1000) {
          return (num / 1000).toFixed(1) + "K";
        }
        return num.toString();
      }

      // New Date Formatter (Jan 1, 2025)
      function formatDate(dateString) {
          if(!dateString) return "Unknown";
          const date = new Date(dateString);
          return date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
          });
      }

      // Parse ISO 8601 duration (e.g., "PT4M13S" -> "4:13")
      function parseDuration(duration) {
        if (!duration) return null;
        
        const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
        if (!match) return null;
        
        const hours = parseInt(match[1]) || 0;
        const minutes = parseInt(match[2]) || 0;
        const seconds = parseInt(match[3]) || 0;
        
        if (hours > 0) {
          return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        } else {
          return `${minutes}:${String(seconds).padStart(2, '0')}`;
        }
      }

      // Get duration in seconds for classification
      function getDurationInSeconds(duration) {
        if (!duration) return 0;
        
        const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
        if (!match) return 0;
        
        const hours = parseInt(match[1]) || 0;
        const minutes = parseInt(match[2]) || 0;
        const seconds = parseInt(match[3]) || 0;
        
        return hours * 3600 + minutes * 60 + seconds;
      }

      function renderRow(videos, container, statusEl, loadMoreBtn, sectionKey, isShortSection, isLiveSection = false) {
        // Save scroll position for shorts container
        const prevScrollLeft = isShortSection ? container.scrollLeft : 0;
        
        container.innerHTML = "";
        
        let filtered;
        
        if (isShortSection) {
          // Shorts section: ONLY shorts
          // Note: We already pass sorted/filtered shorts here from renderAll, 
          // but we double check classification to be safe or just use 'videos' directly
          // since renderAll does the heavy lifting for shorts sorting now.
          filtered = videos; 
        } else if (isLiveSection) {
          // Live section: ONLY live (exclude misclassified shorts if any)
          filtered = videos.filter((v) => classifyVideo(v) === "live");
        } else {
          // Regular sections: EXCLUDE shorts and live
          filtered = videos.filter((v) => {
            const tag = classifyVideo(v);
            if (tag === "shorts" || tag === "live") return false;
            return passesFilter(v, false);
          });
        }

        if (!filtered || filtered.length === 0) {
          statusEl.textContent = isLiveSection ? "No live streams at the moment" : "No videos for this filter.";
          if(loadMoreBtn) loadMoreBtn.classList.add('hidden');
          return;
        }
        statusEl.textContent = "";
        // Get how many videos to show from state
        const limit = loadMoreState[sectionKey];
        const videosToShow = filtered.slice(0, limit);
        const hasMore = filtered.length > limit;
        // Render videos
        videosToShow.forEach((video) => {
          // HANDLE BOTH STRING AND OBJECT IDs
          const videoId = typeof video.id === 'string' ? video.id : (video.id && video.id.videoId ? video.id.videoId : null);
          
          if (!videoId) return;
          const title = (video.snippet && video.snippet.title) || "Untitled";
          const channel = (video.snippet && video.snippet.channelTitle) || "Unknown";
          // UPDATED: Use format function
          const publishedDate = video.snippet && video.snippet.publishedAt ? formatDate(video.snippet.publishedAt) : "Unknown";
          const tag = classifyVideo(video);
          const isShort = isShortSection || tag === "shorts";
          // New Logic for Live Card
          const isLive = tag === "live";
          const cardClass = "video-card" + (isShort ? " short" : "") + (isLive ? " live-card" : "");
          
          const card = document.createElement("div");
          card.className = cardClass;
          card.onclick = () => openLightbox(videoId, isShort);
          const thumbClass = isShort ? "video-thumb ratio-shorts" : "video-thumb ratio-16x9";
          // Custom class for live tag color
          const tagClass = tag === "live" ? "live-tag" : (isShort ? "short-tag" : "");
          
          // Get statistics and duration
          const viewCount = video.statistics && video.statistics.viewCount ? formatViewCount(video.statistics.viewCount) : null;
          const duration = video.contentDetails && video.contentDetails.duration ? parseDuration(video.contentDetails.duration) : null;
          
          const statsBadge = viewCount ? `<div class="stats-badge"><i class="ph ph-eye"></i>${viewCount}</div>` : '';
          const durationBadge = duration ? `<div class="duration-badge">${duration}</div>` : '';
          
          card.innerHTML = `
          
			<div class="${thumbClass}">
				<img src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" loading="lazy" alt="">
				${statsBadge}
				${durationBadge}
					<div class="overlay-icon">
						<i class="ph-fill ph-play"></i>
					</div>
				</div>
				<div class="video-info">
                    <div class="video-text-group">
					    <div class="video-title">${title}</div>
                        <div class="video-meta">
                            <span>${channel}</span>
                            <span>â€¢</span>
                            <span>${publishedDate}</span>
                        </div>
                    </div>
                    <div class="video-footer">
					    <div class="video-tag ${tagClass}">${tagLabel(tag)}</div>
                    </div>
				</div>
        `;
          container.appendChild(card);
        });
        
        // Show or hide Load More button (if exists)
        if (loadMoreBtn) {
            if (hasMore) {
              loadMoreBtn.classList.remove('hidden');
            } else {
              loadMoreBtn.classList.add('hidden');
            }
        }
        
        // Restore scroll position for shorts
        if (isShortSection) {
            container.scrollLeft = prevScrollLeft;
        }
      }

      function tagLabel(tag) {
        const labels = {
          live: "Live",
          walkthrough: "Walkthrough",
          review: "Review", // Added label
          ost: "Soundtrack",
          trailer: "Trailer",
          remaster: "Remaster",
          speedrun: "Speedrun",
          shorts: "Short",
          other: "Other"
        };
        return labels[tag] || "Other";
      }
      // --- Lightbox Logic ---
      function openLightbox(videoId, isShort) {
        if (isShort) {
          lightboxContent.classList.add('short-mode');
        } else {
          lightboxContent.classList.remove('short-mode');
        }
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
        iframe.setAttribute("allowfullscreen", "");
        iframe.setAttribute("allow", "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture");
        iframe.className = "lightbox-iframe";
        lightboxContent.innerHTML = "";
        lightboxContent.appendChild(iframe);
        lightbox.classList.add('active');
      }

      function closeLightbox() {
        lightbox.classList.remove('active');
        setTimeout(() => {
          lightboxContent.innerHTML = ""; // Stop video
        }, 300);
      }
      lightboxClose.addEventListener("click", closeLightbox);
      lightbox.addEventListener("click", (e) => {
        if (e.target === lightbox) closeLightbox();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === "Escape") closeLightbox();
      });
      // --- Load More Logic ---
      function handleLoadMore(sectionKey) {
        // Increase the limit by 10 (or 10 for shorts)
        const increment = 10;
        loadMoreState[sectionKey] += increment;
        // Re-render everything
        renderAll();
      }
      MOST_VIEWED_LOAD_MORE.addEventListener("click", () => handleLoadMore('mostViewed'));
      TRENDING_LOAD_MORE.addEventListener("click", () => handleLoadMore('trending'));
      LIVE_LOAD_MORE.addEventListener("click", () => handleLoadMore('live'));
      NEW_LOAD_MORE.addEventListener("click", () => handleLoadMore('newest'));
      // Remove listener for shorts load more since button is removed
      // --- Sorting Pills Logic ---
      const mostViewedSortContainer = document.getElementById('most-viewed-sort');
      const trendingSortContainer = document.getElementById('trending-sort');
      const shortsSortContainer = document.getElementById('shorts-sort'); // New container

      mostViewedSortContainer.addEventListener('click', (e) => {
        const pill = e.target.closest('.sort-pill');
        if (!pill) return;
        const timeframe = pill.dataset.timeframe;
        sortState.mostViewed = timeframe;
        // Update active state
        mostViewedSortContainer.querySelectorAll('.sort-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        // Reset load more and re-render
        loadMoreState.mostViewed = 10;
        renderAll();
      });
      trendingSortContainer.addEventListener('click', (e) => {
        const pill = e.target.closest('.sort-pill');
        if (!pill) return;
        const timeframe = pill.dataset.timeframe;
        sortState.trending = timeframe;
        // Update active state
        trendingSortContainer.querySelectorAll('.sort-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        // Reset load more and re-render
        loadMoreState.trending = 10;
        renderAll();
      });
      
      // Shorts Sorting Logic
      shortsSortContainer.addEventListener('click', (e) => {
        const pill = e.target.closest('.sort-pill');
        if (!pill) return;
        const sortType = pill.dataset.sort;
        sortState.shorts = sortType;
        // Update active state
        shortsSortContainer.querySelectorAll('.sort-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        // We don't necessarily reset load more state for shorts to keep scroll position feeling nice,
        // but re-rendering will apply the new sort order immediately.
        renderAll();
        // Optional: scroll back to start on sort change?
        SHORTS_CONTAINER.scrollLeft = 0;
      });

      // --- Shorts Scroller Logic ---
      const shortsPrevBtn = document.getElementById('shorts-prev');
      const shortsNextBtn = document.getElementById('shorts-next');
      
      shortsPrevBtn.addEventListener('click', () => {
          SHORTS_CONTAINER.scrollBy({ left: -SHORTS_CONTAINER.clientWidth, behavior: 'smooth' });
      });
      
      shortsNextBtn.addEventListener('click', () => {
          const container = SHORTS_CONTAINER;
          const currentScroll = container.scrollLeft;
          const maxScroll = container.scrollWidth - container.clientWidth;
          
          // Check if we are near the end (within 50px)
          if (maxScroll - currentScroll < 50) {
              handleLoadMore('shorts'); // Load next batch
          }
          
          container.scrollBy({ left: container.clientWidth, behavior: 'smooth' });
      });

      fetchVideos();
    </script>
  </body>
</html>